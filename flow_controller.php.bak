<?php
/**
 * 회원관리 Business Logics
 */

require_once 'lib/_init.php';
$database = new Database();
$session = new Session();
include_once 'lib/sendmail.class.php';
$mailer = new Mailer();

/**
 * 임시 비밀번호용 랜덤 문자열 생성
 *
 * @param	length	문자열 생성 길이
 * @return	string
 */
function getRandomPassword($length = 10) {
	$characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
	$charactersLength = strlen($characters);
	$randomString = '';
	for ($i = 0; $i < $length; $i++) {
		$randomString .= $characters[rand(0, $charactersLength - 1)];
	}
	return $randomString;
}

$task = getAnyParameter("task",0);
error_log(var_export($_GET, 1));
error_log(var_export($_POST, 1));
error_log($task);

switch ($task) {
	
	case 'getManagerInfo': // 사용자 리스트 취득 
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];
		$MANAGER_SQ = getAnyParameter("USER_SQ",0);

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "멤버리스트";
		$SUBCATEGORY = "";
		$ACTION = $MANAGER_SQ."사용자 상세정보를 조회하였습니다.";
		$IP = getClientIPv4();
		
		// DB 조회
		$database->prepare("
			select a.USER_SQ,a.CENTER_SQ,a.USER_NM,a.PHONE_NO,a.GENDER,a.ADDRESS,a.EMAIL,a.BIRTH_DT, a.REG_DT, a.GRADE,
						a.WORKCATEGORY, a.WORKTYPE, a.WORKSTARTDATE, a.WORKENDDATE, a.WORKSTATUS
					from tb_user a  left outer join tb_user b on a.TRAINER=b.USER_SQ
					where a.USER_SQ=:USER_SQ order by a.REG_DT desc
		");
		$database->bind(':USER_SQ', $MANAGER_SQ);
		$database->execute();

		$rows = $database->fetchAll();
		$memberlist = json_encode($rows);

		$database->prepare("
			select WC_SEQ,CENTER_SQ,NAME,RANK
					from tb_work_category where CENTER_SQ=:CENTER_SQ order by RANK asc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();

		$rows = $database->fetchAll();
		$workcategorylist = json_encode($rows);

		$database->prepare("
			select COMMON_SQ,BASE_CD,CODE,NAME,DESCRIPTION
					from tb_common where BASE_CD='CD003' and CODE>0 order by CODE asc
		");
		$database->execute();

		$rows = $database->fetchAll();
		$workstatuslist = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($memberlist.'|'.$workcategorylist.'|'.$workstatuslist);
		break;
	
	case 'execManagerAddInfoModify': // 임직원 관리정보 수정 
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];
		$MANAGER_SQ = getAnyParameter("USER_SQ",0);
		$WORKCATEGORY = getAnyParameter("WORKCATEGORY",0);
		$WORKSTATUS = getAnyParameter("WORKSTATUS",0);
		$WORKSTARTDATE = getAnyParameter("WORKSTARTDATE","");
		$WORKENDDATE = getAnyParameter("WORKENDDATE","");

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "임직원 설정";
		$SUBCATEGORY = "임직원 관리정보 변경";
		$ACTION = $MANAGER_SQ . " 임직원 관리정보를 변경하였습니다.";
		$IP = getClientIPv4();
		
		// DB 실행
		if (strlen($WORKSTARTDATE) == 0) {
			$WORKSTARTDATE='0000-00-00';
		}
		if (strlen($WORKENDDATE) == 0) {
			$WORKENDDATE='0000-00-00';
		}
		$database->prepare("
			update tb_user set WORKCATEGORY=:WORKCATEGORY, WORKSTATUS=:WORKSTATUS, WORKSTARTDATE=:WORKSTARTDATE, WORKENDDATE=:WORKENDDATE  where USER_SQ=:USER_SQ
		");
		$database->bind(':WORKCATEGORY', $WORKCATEGORY);
		$database->bind(':WORKSTATUS', $WORKSTATUS);
		$database->bind(':WORKSTARTDATE', $WORKSTARTDATE);
		$database->bind(':WORKENDDATE', $WORKENDDATE);
		$database->bind(':USER_SQ', $MANAGER_SQ);
		$database->execute();
		
        $result = '1';

        if ($database->rowCount() < 1) { 
            $result = '0';
            exit($result);
        }
		
		// 최종 결과 취득 
		$database->prepare("
			select a.USER_SQ,a.CENTER_SQ,a.USER_NM,a.PHONE_NO,a.ADDRESS,a.EMAIL,a.BIRTH_DT, a.REG_DT, a.GRADE,
						a.WORKCATEGORY, a.WORKTYPE, a.WORKSTARTDATE, a.WORKENDDATE, a.WORKSTATUS
					from tb_user a  left outer join tb_user b on a.TRAINER=b.USER_SQ
					where a.CENTER_SQ=:CENTER_SQ and a.ISMANAGER=1 order by a.REG_DT desc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();
		
		$rows = $database->fetchAll();
		$memberlist = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($memberlist);
		break;
			
	case 'execWorkCategryDelete': // 카테고리 수정  
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];
		$WC_SEQ = getAnyParameter("WC_SEQ",0);

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "임직원 설정";
		$SUBCATEGORY = "카테고리 삭제";
		$ACTION = $WC_SEQ . " 카테고리를 삭제하였습니다.";
		$IP = getClientIPv4();
		
		// DB 실행
		$database->prepare("
			delete from tb_work_category where WC_SEQ=:WC_SEQ
		");
		$database->bind(':WC_SEQ', $WC_SEQ);
		$database->execute();
		
        $result = '1';

        if ($database->rowCount() < 1) { 
            $result = '0';
            exit($result);
        }
		
		// DB 다시 취득.
		$database->prepare("
			select WC_SEQ,CENTER_SQ,NAME,RANK
					from tb_work_category where CENTER_SQ=:CENTER_SQ order by RANK asc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();
		$rows = $database->fetchAll();
		
		$ind = 0;
		foreach ($rows as $row)
		{
			// DB 실행 - 하나씩 랭크를 재조정한다.
			$database->prepare("
				update tb_work_category SET RANK=:RANK
						where WC_SEQ=:WC_SEQ
			");
			$database->bind(':RANK', $ind++);
			$database->bind(':WC_SEQ', $row["WC_SEQ"]);
			$database->execute();
		}
		
		// DB 실행
		$database->prepare("
			update tb_user set WorkCategory=0 where WorkCategory=:WC_SEQ and CENTER_SQ=:CENTER_SQ
		");
		$database->bind(':WC_SEQ', $WC_SEQ);
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();

		// 최종 결과 취득 
		$database->prepare("
			select WC_SEQ,CENTER_SQ,NAME,RANK
					from tb_work_category where CENTER_SQ=:CENTER_SQ order by RANK asc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();
		$rows = $database->fetchAll();
		$workcategorylist = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($workcategorylist);
		break;
		
	case 'execWorkCategryModify': // 카테고리 수정  
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];
		$WC_SEQ = getAnyParameter("WC_SEQ",0);
		$NAME = getAnyParameter("NAME","");

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "임직원 설정";
		$SUBCATEGORY = "카테고리 명칭 변경";
		$ACTION = $WC_SEQ . " 카테고리 명칭을 변경하였습니다.";
		$IP = getClientIPv4();
		
		// DB 실행
		$database->prepare("
			update tb_work_category set NAME=:NAME where WC_SEQ=:WC_SEQ
		");
		$database->bind(':NAME', $NAME);
		$database->bind(':WC_SEQ', $WC_SEQ);
		$database->execute();
		
        $result = '1';

        if ($database->rowCount() < 1) { 
            $result = '0';
            exit($result);
        }

		// 최종 결과 취득 
		$database->prepare("
			select WC_SEQ,CENTER_SQ,NAME,RANK
					from tb_work_category where CENTER_SQ=:CENTER_SQ order by RANK asc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();
		$rows = $database->fetchAll();
		$workcategorylist = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($workcategorylist);
		break;

	case 'execWorkCategryAdd': // 카테고리 생성  
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];
		$NAME = getAnyParameter("NAME",0);

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "임직원 설정";
		$SUBCATEGORY = "카테고리 생성";
		$ACTION = $NAME . " 카테고리를 생성하였습니다.";
		$IP = getClientIPv4();
		
		// 존재여부확인 
		$database->prepare("
			select WC_SEQ from tb_work_category 
					where CENTER_SQ=:CENTER_SQ AND NAME=:NAME
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->bind(':NAME', $NAME);
		$database->execute();
		
        $result = '1';

        if ($database->rowCount() >0) { 
            $result = '동일한 이름이 존재합니다.';
            exit("{\"result\":\"".$result."\"}");
        }

		// DB 실행
		$database->prepare("
			insert tb_work_category (CENTER_SQ, NAME, RANK)
					SELECT :CENTER_SQ, :NAME, MAX(RANK)+1 FROM tb_work_category WHERE CENTER_SQ=:CENTER_SQ2
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->bind(':NAME', $NAME);
		$database->bind(':CENTER_SQ2', $CENTER_SQ);
		$database->execute();
		
        $result = '1';

        if ($database->rowCount() < 1) { 
            $result = '0';
            exit($result);
        }

		// DB 다시 취득.
		$database->prepare("
			select WC_SEQ,CENTER_SQ,NAME,RANK
					from tb_work_category where CENTER_SQ=:CENTER_SQ order by RANK asc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();
		$rows = $database->fetchAll();
		$workcategorylist = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($workcategorylist);
		break;

	case 'execWorkCategryRankChange': // 사용자 리스트 취득 
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];
		$WC_SEQ = getAnyParameter("WC_SEQ",0);
		$UPDOWN = getAnyParameter("UPDOWN",1);

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "임직원 설정";
		$SUBCATEGORY = "카테고리 순서 변경";
		$ACTION = $WC_SEQ . " 카테고리 순서를 변경하였습니다.";
		$IP = getClientIPv4();
		
		// DB 실행
		$database->prepare("
			update tb_work_category SET RANK=RANK+(:RANK)
					where WC_SEQ=:WC_SEQ
		");
		$database->bind(':RANK', $UPDOWN * 1.5);
		$database->bind(':WC_SEQ', $WC_SEQ);
		$database->execute();
		error_log($UPDOWN * 0.5);

        $result = '1';

        if ($database->rowCount() < 1) { 
            $result = '0';
            exit($result);
        }

		// DB 다시 취득.
		$database->prepare("
			select WC_SEQ,CENTER_SQ,NAME,RANK
					from tb_work_category where CENTER_SQ=:CENTER_SQ order by RANK asc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();
		$rows = $database->fetchAll();
		
		$ind = 0;
		foreach ($rows as $row)
		{
			error_log($row["WC_SEQ"]);
			error_log($row["RANK"]);
			// DB 실행 - 하나씩 랭크를 재조정한다.
			$database->prepare("
				update tb_work_category SET RANK=:RANK
						where WC_SEQ=:WC_SEQ
			");
			$database->bind(':RANK', $ind++);
			$database->bind(':WC_SEQ', $row["WC_SEQ"]);
			$database->execute();
		}

		// 최종 결과 취득 
		$database->prepare("
			select WC_SEQ,CENTER_SQ,NAME,RANK
					from tb_work_category where CENTER_SQ=:CENTER_SQ order by RANK asc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();
		$rows = $database->fetchAll();
		$workcategorylist = json_encode($rows);
			error_log($CENTER_SQ);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($workcategorylist);
		break;

	case 'execManagerRegister': // 관리 사이트 사용자로 등록 
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];
		$MANAGER_SEQ = getAnyParameter("USER_SQ",0);

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "임직원 설정";
		$SUBCATEGORY = "임직원 등록";
		$ACTION = $USER_SQ . " 임직원을 등록하였습니다.";
		$IP = getClientIPv4();
		
		// DB 실행 
		$database->prepare("
			UPDATE tb_user SET GRADE=2 
					where CENTER_SQ=:CENTER_SQ and USER_SQ=:MANAGER_SEQ
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->bind(':MANAGER_SEQ', $MANAGER_SEQ);
		$database->execute();
		
        $result = '1';

        if ($database->rowCount() < 1) { 
            $result = '0';
            exit($result);
        }

		// DB 조회
		$database->prepare("
			select a.USER_SQ,a.CENTER_SQ,a.USER_NM,a.PHONE_NO,a.ADDRESS,a.EMAIL,a.BIRTH_DT, a.REG_DT, a.GRADE,
						a.WORKCATEGORY, a.WORKTYPE, a.WORKSTARTDATE, a.WORKENDDATE, a.WORKSTATUS
					from tb_user a  left outer join tb_user b on a.TRAINER=b.USER_SQ
					where a.CENTER_SQ=:CENTER_SQ and a.ISMANAGER=1 order by a.REG_DT desc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();
		
		$rows = $database->fetchAll();
		$memberlist = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($memberlist);
		break;
	
	case 'getManagerList': // 사용자 리스트 취득 
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "멤버리스트";
		$SUBCATEGORY = "";
		$ACTION = "사용자 리스트를 조회하였습니다.";
		$IP = getClientIPv4();
		
		// DB 조회
		$database->prepare("
			select a.USER_SQ,a.CENTER_SQ,a.USER_NM,a.PHONE_NO,a.ADDRESS,a.EMAIL,a.BIRTH_DT, a.REG_DT, a.GRADE,
						a.WORKCATEGORY, a.WORKTYPE, a.WORKSTARTDATE, a.WORKENDDATE, a.WORKSTATUS
					from tb_user a  left outer join tb_user b on a.TRAINER=b.USER_SQ
					where a.CENTER_SQ=:CENTER_SQ and a.ISMANAGER=1 order by a.REG_DT desc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();

		$rows = $database->fetchAll();
		$memberlist = json_encode($rows);

		$database->prepare("
			select WC_SEQ,CENTER_SQ,NAME,RANK
					from tb_work_category where CENTER_SQ=:CENTER_SQ order by RANK asc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();

		$rows = $database->fetchAll();
		$workcategorylist = json_encode($rows);

		$database->prepare("
			select COMMON_SQ,BASE_CD,CODE,NAME,DESCRIPTION
					from tb_common where BASE_CD='CD003' and CODE>0 order by CODE asc
		");
		$database->execute();

		$rows = $database->fetchAll();
		$workstatuslist = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($memberlist.'|'.$workcategorylist.'|'.$workstatuslist);
		break;

    case 'AllCenter':
 		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
        $CENTER_LIST = [];
        $DB = mysqli_connect("localhost","liansoft2","liansoft2!","liansoft2");
        $SQL = "SELECT * FROM tb_center";
        $result = mysqli_query($DB,$SQL);
        while($row = mysqli_fetch_array($result)){
            $data = new stdClass();
            $data -> CENTER_SQ = $row[0];
            $data -> CENTER_NM = $row[1];
            $CENTER_LIST[] = $data;
            unset($data);
        }
        $CENTER_LIST = json_encode($CENTER_LIST);
        exit($CENTER_LIST);

    case 'EditUserInfo':
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
        $MEMBER_SQ = getAnyParameter("MEMBER_SQ","");
        $USER_NM = getAnyParameter("USER_NM","");
        $GENDER = getAnyParameter("GENDER","");
        $PHONE_NO = getAnyParameter("PHONE_NO","");
        $BIRTH_DT = getAnyParameter("BIRTH_DT","");
        $EMAIL = getAnyParameter("EMAIL","");
        $CENTER_SQ = getAnyParameter("CENTER_SQ","");

        //$CENTER_SQ = $session->user["CENTER_SQ"];

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "사용자 정보";
		$SUBCATEGORY = "사용자 정보 수정";
		$ACTION = $USERID . " 회원의 정보가 수정되었습니다.";
        $IP = getClientIPv4();
            
        $database->prepare("
            UPDATE tb_user SET 
            USER_NM = :USER_NM, 
            GENDER = :GENDER, 
            PHONE_NO = :PHONE_NO, 
            BIRTH_DT = :BIRTH_DT, 
            EMAIL = :EMAIL, 
            CENTER_SQ = :CENTER_SQ
            where USER_SQ=:MEMBER_SQ
		");
		$database->bind(':USER_NM', $USER_NM);
		$database->bind(':GENDER', $GENDER);
		$database->bind(':PHONE_NO', $PHONE_NO);
		$database->bind(':BIRTH_DT', $BIRTH_DT);
		$database->bind(':EMAIL', $EMAIL);
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->bind(':MEMBER_SQ', $MEMBER_SQ);
        $database->execute();

        $result = '1';

        if ($database->rowCount() < 1) { 
            $result = '0';
            exit($result);
        }

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($result);
        break;
        
    case 'UpdateComment':
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
        $COMMENT = getAnyParameter("COMMENT","");
        $MEMBER_SQ = getAnyParameter("USER_SQ","");
        $CENTER_SQ = $session->user["CENTER_SQ"];

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "사용자 정보";
		$SUBCATEGORY = "사용자 메모 수정";
		$ACTION = $USERID . " 회원의 메모가 수정되었습니다.";
        $IP = getClientIPv4();
            
        $database->prepare("
			update tb_user SET COMMENT = :COMMENT where USER_SQ=:MEMBER_SQ
		");
		$database->bind(':COMMENT', $COMMENT);
		$database->bind(':MEMBER_SQ', $MEMBER_SQ);
        $database->execute();

        $result = true;

        if ($database->rowCount() < 1) { 
            $result = false;
            exit($result);
        }

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($result);
		break;
	
	case 'DeleteMeasurement': // 사용자 리스트 취득 
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		// 파라메터 취득
		$MEASUREMENT_TYPE = getAnyParameter("MEASUREMENT_TYPE","");
		$MEASUREMENT_SQ = getAnyParameter("MEASUREMENT_SQ","");
		$CENTER_SQ = $session->user["CENTER_SQ"];

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "건강정보";
		$SUBCATEGORY = "측정정보";
		$ACTION = $USERID . " 회원 자세측정정보를 삭제하였습니다.";
        $IP = getClientIPv4();
        
        //bs_measurement
		//bs_posedata, bs_romdata
        // 날짜 정보 데이터
        $result = json_encode("Success");

		$database->prepare("
			delete from bs_measurement where MEASUREMENT_SQ=:MEASUREMENT_SQ
		");
		$database->bind(':MEASUREMENT_SQ', $MEASUREMENT_SQ);
        $database->execute();
        
        if ($database->rowCount() < 1) { 
            $result = json_encode("Fail");
            exit($result);
        }
        
        switch ($MEASUREMENT_TYPE){
            // POSE 데이터
            case 'pose' :
                $database->prepare("
                    delete from bs_posedata where MEASUREMENT_SQ=:MEASUREMENT_SQ
                ");
                $database->bind(':MEASUREMENT_SQ', $MEASUREMENT_SQ);
                $database->execute();

		        if ($database->rowCount() < 1) { 
                    $result = json_encode("Fail1");
                    exit($result);
                }
                break;
            
            // ROM 데이터
            case 'rom' :
                $database->prepare("
                    delete from bs_romdata where MEASUREMENT_SQ=:MEASUREMENT_SQ
                ");
                $database->bind(':MEASUREMENT_SQ', $MEASUREMENT_SQ);
                $database->execute();

		        if ($database->rowCount() < 1) { 
                    $result = json_encode("Fail2");
                    exit($result);
                }
                break;
        }
		
		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($result);
		break;

    case 'SaveMedicalExamData': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		$USER_SEQ = getAnyParameter("USER_SEQ",""); // 저장할 대상자의 회원일련번호
		$desaInfo_Date = getAnyParameter("desaInfo_Date","");
		$HR = getAnyParameter("desaInfo_HR",0);
		$SBP = getAnyParameter("desaInfo_SBP",0);
		$DBP = getAnyParameter("desaInfo_DBP",0);
		$Glucose = getAnyParameter("desaInfo_Glucose",0);
		$HbA1c = getAnyParameter("desaInfo_HbA1c",0);
		$TC = getAnyParameter("desaInfo_TC",0);
		$HDL = getAnyParameter("desaInfo_HDL",0);
		$LDL = getAnyParameter("desaInfo_LDL",0);
		$TG = getAnyParameter("desaInfo_TG",0);
		$Lactate = getAnyParameter("desaInfo_Lactate",0);
		
		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];  //로그인 사용자의 회원일련번호 
		$USERID = "";
		$DEVICE_SQ = -1;
		$CATEGORY = "사용자 정보등록";
		$SUBCATEGORY = "사용자 대사검진 정보등록";
		$ACTION = $USER_SEQ . " 사용자의 대사검진 정보를 등록하였습니다.";
		$IP = getClientIPv4();

		$database->prepare("insert into bs_measurement ( USER_SQ, DEVICE_SQ, MEASUREMENT_TYPE, DONE, REG_DT )
								values ( :USER_SQ, 0, 'HEALTH', 1, :REG_DT ); SELECT LAST_INSERT_ID() as MEASUREMENT_SQ
						");
		$database->bind(':USER_SQ', $USER_SEQ);
		$database->bind(':REG_DT', $desaInfo_Date);
		$database->execute();

		$database->prepare("select MEASUREMENT_SQ from bs_measurement 
								where  USER_SQ=:USER_SQ ORDER BY MEASUREMENT_SQ DESC LIMIT 1
						");
		$database->bind(':USER_SQ', $USER_SEQ);
		$database->execute();
		$row = $database->fetch();
		$MEASUREMENT_SQ = $row["MEASUREMENT_SQ"];

		error_log('$MEASUREMENT_SQ='. $MEASUREMENT_SQ);
		
		$database->prepare("insert into bs_health ( MEASUREMENT_SQ,HR,SBP,DBP,Glucose, HbA1c,TC,HDL,LDL,TG,Lactate,REG_DT )
								values ( :MEASUREMENT_SQ, :HR, :SBP, :DBP, :Glucose, :HbA1c, :TC, :HDL, :LDL, :TG, :Lactate, :REG_DT )
						");
		$database->bind(':MEASUREMENT_SQ', $MEASUREMENT_SQ);
		$database->bind(':HR', $HR);
		$database->bind(':SBP', $SBP);
		$database->bind(':DBP', $DBP);
		$database->bind(':Glucose', $Glucose);
		$database->bind(':HbA1c', $HbA1c);
		$database->bind(':TC', $TC);
		$database->bind(':HDL', $HDL);
		$database->bind(':LDL', $LDL);
		$database->bind(':TG', $TG);
		$database->bind(':Lactate', $Lactate);
		$database->bind(':REG_DT', $desaInfo_Date);
		$database->execute();
		
		error_log($database->rowCount());
		if ($database->rowCount() < 1) { 
			$response_array["result"] = 'fail';
			exit(json_encode($response_array));
		}
				
		// HEALTH 리스트
		$database->prepare("
			select MEASUREMENT_SQ,USER_SQ,DEVICE_SQ,MEASUREMENT_TYPE,DONE,REG_DT
					from bs_measurement where DONE=1 AND MEASUREMENT_TYPE='HEALTH' AND USER_SQ=:USER_SQ order by REG_DT DESC
		");
		$database->bind(':USER_SQ', $USER_SEQ);
		$database->execute();

		$rows = $database->fetchAll();
		$healthlist = json_encode($rows);

		// HEALTH 데이터 
		$database->prepare("
			SELECT MEASUREMENT_SQ,REG_DT,HR,SBP,DBP,GLUCOSE,HbA1c,TC,HDL,LDL,TG,Lactate FROM bs_health 
				WHERE MEASUREMENT_SQ in (SELECT MEASUREMENT_SQ FROM bs_measurement WHERE USER_SQ=:USER_SQ) 
			order by reg_dt asc;
		");
		$database->bind(':USER_SQ', $USER_SEQ);
		$database->execute();

		$rows = $database->fetchAll();
		$healthdata = json_encode($rows);

		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		error_log(json_encode($healthlist.'|'.$healthdata));
		exit($healthlist.'|'.$healthdata);
		break;
			
	case 'SaveInbodyData': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		$USER_SEQ = getAnyParameter("USER_SEQ",""); // 저장할 대상자의 회원일련번호
		$bodyInfo_Date = getAnyParameter("bodyInfo_Date","");
		$bodyInfo_Height = getAnyParameter("bodyInfo_Height",0);
		$bodyInfo_Weight = getAnyParameter("bodyInfo_Weight",0);
		$bodyInfo_Fat = getAnyParameter("bodyInfo_Fat",0);
		$bodyInfo_Muscle = getAnyParameter("bodyInfo_Muscle",0);
		
		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];  //로그인 사용자의 회원일련번호 
		$USERID = "";
		$DEVICE_SQ = -1;
		$CATEGORY = "사용자 정보등록";
		$SUBCATEGORY = "사용자 신체정보등록";
		$ACTION = $USER_SEQ . " 사용자의 신체정보를 등록하였습니다.";
		$IP = getClientIPv4();

		$database->prepare("insert into bs_measurement ( USER_SQ, DEVICE_SQ, MEASUREMENT_TYPE, DONE, REG_DT )
								values ( :USER_SQ, 0, 'INBODY', 1, :REG_DT ); SELECT LAST_INSERT_ID() as MEASUREMENT_SQ
						");
		$database->bind(':USER_SQ', $USER_SEQ);
		$database->bind(':REG_DT', $bodyInfo_Date);
		$database->execute();

		$database->prepare("select MEASUREMENT_SQ from bs_measurement 
								where  USER_SQ=:USER_SQ ORDER BY MEASUREMENT_SQ DESC LIMIT 1
						");
		$database->bind(':USER_SQ', $USER_SEQ);
		$database->execute();
		$row = $database->fetch();
		$MEASUREMENT_SQ = $row["MEASUREMENT_SQ"];
		
		error_log('$row = '.var_export($row, 1));	
		error_log($database->rowCount());
		error_log('$MEASUREMENT_SQ='. $MEASUREMENT_SQ);
		
		$database->prepare("insert into bs_inbody ( MEASUREMENT_SQ,HEIGHT,WEIGHT,FAT,MUSCLE,REG_DT )
								values ( :MEASUREMENT_SQ, :HEIGHT, :WEIGHT, :FAT, :MUSCLE, :REG_DT )
						");
		$database->bind(':MEASUREMENT_SQ', $MEASUREMENT_SQ);
		$database->bind(':HEIGHT', $bodyInfo_Height);
		$database->bind(':WEIGHT', $bodyInfo_Weight);
		$database->bind(':FAT', $bodyInfo_Fat);
		$database->bind(':MUSCLE', $bodyInfo_Muscle);
		$database->bind(':REG_DT', $bodyInfo_Date);
		$database->execute();
		
		error_log($database->rowCount());
		if ($database->rowCount() < 1) { 
			$response_array["result"] = 'fail';
			exit(json_encode($response_array));
		}
				
		// 신체정보 리스트
		$database->prepare("
			select MEASUREMENT_SQ,USER_SQ,DEVICE_SQ,MEASUREMENT_TYPE,DONE,REG_DT
					from bs_measurement where DONE=1 AND MEASUREMENT_TYPE='INBODY' AND USER_SQ=:USER_SQ order by REG_DT DESC
		");
		$database->bind(':USER_SQ', $USER_SEQ);
		$database->execute();

		$rows = $database->fetchAll();
		$inbodylist = json_encode($rows);
		
		// INBODY 데이터 
		$database->prepare("
			SELECT MEASUREMENT_SQ,REG_DT,HEIGHT,WEIGHT,FAT,MUSCLE FROM bs_inbody 
					WHERE MEASUREMENT_SQ in (SELECT MEASUREMENT_SQ FROM bs_measurement WHERE USER_SQ=:USER_SQ)
			order by reg_dt asc;
		");
		$database->bind(':USER_SQ', $USER_SEQ);
		$database->execute();

		$rows = $database->fetchAll();
		$inbodydata = json_encode($rows);

		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		error_log(json_encode($inbodylist.'|'.$inbodydata));
		exit($inbodylist.'|'.$inbodydata);
		break;
		
	case 'UserRegSimple': // 직원 로그인
		// 파라메터 취득
		$u_name = getAnyParameter("u_name","");
		$u_year = getAnyParameter("u_year","");
		$u_gender = getAnyParameter("u_gender","");
		$u_num = getAnyParameter("u_num","");
		$u_email = getAnyParameter("u_email","");
		$u_teacher = getAnyParameter("u_teacher","");
		$u_address = getAnyParameter("u_address","");
		$u_memo = getAnyParameter("u_memo","");
		
		$CENTER_SQ = $session->user["CENTER_SQ"];
		$u_id = str_replace("-","", $u_num);
		if (strlen($u_id) >10 )
			$u_id = substr($u_id,strlen($u_id)-8, 8);

		$pwd_encrypted = Hash_Sha256(substr($u_id,strlen($u_id)-4, 4));
		
		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = "";
		$DEVICE_SQ = -1;
		$CATEGORY = "멤버리스트";
		$SUBCATEGORY = "사용자간이등록";
		$ACTION = $u_name + " 사용자를 등록하였습니다.";
		$IP = getClientIPv4();
		
		// DB 조회
		$database->prepare("
			INSERT tb_user (CENTER_SQ,USERID,GENDER,USER_NM,PHONE_NO,EMAIL,BIRTH_DT,TRAINER,ADDRESS,`COMMENT`, PWD_ENCRYPTED, GRADE, ISUSE) VALUES
					(:CENTER_SQ,:USERID,:GENDER,:USER_NM,:PHONE_NO,:EMAIL,:BIRTH_DT,:TRAINER,:ADDRESS,:COMMENT, :PWD_ENCRYPTED, 1, 1)
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->bind(':USERID', $u_id);
		$database->bind(':GENDER', $u_gender);
		$database->bind(':USER_NM', $u_name);
		$database->bind(':PHONE_NO', $u_num);
		$database->bind(':EMAIL', $u_email);
		$database->bind(':BIRTH_DT', $u_year);
		$database->bind(':TRAINER', $u_teacher);
		$database->bind(':ADDRESS', $u_address);
		$database->bind(':COMMENT', $u_memo);
		$database->bind(':PWD_ENCRYPTED', $pwd_encrypted);
		$database->execute();
		
		if ($database->rowCount() > 0) {
			$redirect_location = 'members.php?member_register=success'; // 로그아웃 이후 이동화면
		}
		else {
			$redirect_location = 'members.php?member_register=fail'; // 로그아웃 이후 이동화면
		}

		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		break;
	
	case 'getUserData': // 사용자 리스트 취득 
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		// 파라메터 취득
		$user_sq = getAnyParameter("u_seq","");
		$CENTER_SQ = $session->user["CENTER_SQ"];

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "회원정보";
		$SUBCATEGORY = "";
		$ACTION = $USERID . " 회원 상세정보를 조회하였습니다.";
		$IP = getClientIPv4();
		
		// 사용자 정보 취득 
		$database->prepare("
			select a.USER_SQ,a.CENTER_SQ,c.CENTER_NM,a.USER_NM,a.GENDER, a.PHONE_NO,a.EMAIL,a.BIRTH_DT, a.REG_DT, 
					(select REG_DT from bs_measurement where USER_SQ=a.USER_SQ order by REG_DT desc LIMIT 1) as MEAS_DATE
					,a.TRAINER, b.USER_NM TRAINER_NM,REPLACE(a.COMMENT,'|','_') as COMMENT
			from tb_user a  left outer join tb_user b on a.TRAINER=b.USER_SQ inner join tb_center c on a.CENTER_SQ = c.CENTER_SQ
			where a.USER_SQ=:USER_SQ
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$row = $database->fetch();
		$memberinfo = json_encode($row);
		
		// 신체정보 리스트
		$database->prepare("
			select MEASUREMENT_SQ,USER_SQ,DEVICE_SQ,MEASUREMENT_TYPE,DONE, REG_DT
					from bs_measurement where DONE=1 AND MEASUREMENT_TYPE='INBODY' AND USER_SQ=:USER_SQ order by REG_DT DESC
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$inbodylist = json_encode($rows);
		
		// POSE 정보 리스트
		$database->prepare("
			select MEASUREMENT_SQ,USER_SQ,DEVICE_SQ,MEASUREMENT_TYPE,DONE,REG_DT
					from bs_measurement where DONE=1 AND MEASUREMENT_TYPE='Pose' AND USER_SQ=:USER_SQ order by REG_DT DESC
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$poselist = json_encode($rows);
		
		// ROM 리스트
		$database->prepare("
			select MEASUREMENT_SQ,USER_SQ,DEVICE_SQ,MEASUREMENT_TYPE,DONE,REG_DT
					from bs_measurement where DONE=1 AND MEASUREMENT_TYPE='ROM' AND USER_SQ=:USER_SQ order by REG_DT DESC
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$romlist = json_encode($rows);
		
		// 건강정보  리스트
		$database->prepare("
			select MEASUREMENT_SQ,USER_SQ,DEVICE_SQ,MEASUREMENT_TYPE,DONE,REG_DT
					from bs_measurement where DONE=1 AND MEASUREMENT_TYPE='HEALTH' AND USER_SQ=:USER_SQ order by REG_DT DESC
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();
		
		$rows = $database->fetchAll();
		$healthlist = json_encode($rows);
		
		// INBODY 데이터 
		$database->prepare("
			SELECT MEASUREMENT_SQ,REG_DT,HEIGHT,WEIGHT,FAT,MUSCLE FROM bs_inbody 
					WHERE MEASUREMENT_SQ in (SELECT MEASUREMENT_SQ FROM bs_measurement WHERE USER_SQ=:USER_SQ)
			order by REG_DT asc;
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$inbodydata = json_encode($rows);
		
		// 포즈 측정 결과 데이터
		$database->prepare("
			select a.MEASUREMENT_SQ, a.REG_DT, 
                CASE WHEN (select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=1) = 0
                        THEN (select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=2)
                        ELSE (select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=1) end as front_Neck,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=3) front_RShoulder,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=4) front_LShoulder,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=5) front_RPelvis,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=6) front_LPelvis,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=7) front_RLeg,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=8) front_LLeg,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=9) side_Neck,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=11) side_Shoulder,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=13) side_Pelvis,
				(select angle from bs_posedata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSESTANDARD_SQ=15) side_Leg
			from bs_measurement a  
			where user_sq=:USER_SQ AND MEASUREMENT_TYPE='Pose' and done=1
			order by a.REG_DT asc;
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$posedata = json_encode($rows);
		
		// 포즈 측정 결과 이미지 데이터
		$database->prepare("
			select a.MEASUREMENT_SQ, a.REG_DT, 
				(select PICTURE_NM from bs_picture where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSE_TYPE='front') FRONT_PICTURE,
				(select PICTURE_NM from bs_picture where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSE_TYPE='side') SIDE_PICTURE,
				(select UPLOAD_ROOT from bs_picture where MEASUREMENT_SQ=a.MEASUREMENT_SQ and POSE_TYPE='front') UPLOAD_ROOT
			from bs_measurement a  
			where user_sq=:USER_SQ AND MEASUREMENT_TYPE='Pose' and done=1
			order by a.REG_DT asc;
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$posepicture = json_encode($rows);
        
		// ROM 데이터
		$database->prepare("
			select a.MEASUREMENT_SQ, a.REG_DT, 
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=2) front_Neck_right,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=1) front_Neck_left,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=4) front_Shoulder_right,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=3) front_Shoulder_left,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=6) front_Waist_right,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=5) front_Waist_left,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=8) front_Hip_right,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=7) front_Hip_left,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=9) side_Neck_front,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=10) side_Neck_back,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=11) side_ShoulderL_front,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=12) side_ShoulderL_back,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=13) side_ShoulderR_front,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=14) side_ShoulderR_back,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=15) side_Waist_front,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=16) side_Waist_back,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=17) side_HipL_front,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=18) side_HipL_back,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=19) side_HipR_front,
				(select angle from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=20) side_HipR_back,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=2) front_Neck_right_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=1) front_Neck_left_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=4) front_Shoulder_right_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=3) front_Shoulder_left_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=6) front_Waist_right_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=5) front_Waist_left_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=8) front_Hip_right_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=7) front_Hip_left_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=9) side_Neck_front_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=10) side_Neck_back_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=11) side_ShoulderL_front_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=12) side_ShoulderL_back_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=13) side_ShoulderR_front_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=14) side_ShoulderR_back_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=15) side_Waist_front_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=16) side_Waist_back_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=17) side_HipL_front_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=18) side_HipL_back_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=19) side_HipR_front_grade,
				(select ROM_GRADE from bs_romdata where MEASUREMENT_SQ=a.MEASUREMENT_SQ and ROMSTANDARD_SQ=20) side_HipR_back_grade
			from bs_measurement a  
			where user_sq=:USER_SQ AND MEASUREMENT_TYPE='ROM' and done=1
			order by a.REG_DT asc;
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();

		$romdata = json_encode($rows);

		// HEALTH 데이터 
		$database->prepare("
			SELECT MEASUREMENT_SQ,REG_DT,HR,SBP,DBP,GLUCOSE,HbA1c,TC,HDL,LDL,TG,Lactate FROM bs_health 
				WHERE MEASUREMENT_SQ in (SELECT MEASUREMENT_SQ FROM bs_measurement WHERE USER_SQ=:USER_SQ) 
			order by REG_DT asc;
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$healthdata = json_encode($rows);
		
		// 포즈 표준 데이터
		$database->prepare("
			select 'caution' level, 
				(select caution from bs_posestandard where POSESTANDARD_SQ=1) front_Neck,
				(select caution from bs_posestandard where POSESTANDARD_SQ=3) front_RShoulder,
				(select caution from bs_posestandard where POSESTANDARD_SQ=4) front_LShoulder,
				(select caution from bs_posestandard where POSESTANDARD_SQ=5) front_RPelvis,
				(select caution from bs_posestandard where POSESTANDARD_SQ=6) front_LPelvis,
				(select caution from bs_posestandard where POSESTANDARD_SQ=7) front_RLeg,
				(select caution from bs_posestandard where POSESTANDARD_SQ=8) front_LLeg,
				(select caution from bs_posestandard where POSESTANDARD_SQ=9) side_Neck,
				(select caution from bs_posestandard where POSESTANDARD_SQ=11) side_Shoulder,
				(select caution from bs_posestandard where POSESTANDARD_SQ=13) side_Pelvis,
				(select caution from bs_posestandard where POSESTANDARD_SQ=15) side_Leg
			union
			select 'danger' level,
				(select danger from bs_posestandard where POSESTANDARD_SQ=1) front_Neck,
				(select danger from bs_posestandard where POSESTANDARD_SQ=3) front_RShoulder,
				(select danger from bs_posestandard where POSESTANDARD_SQ=4) front_LShoulder,
				(select danger from bs_posestandard where POSESTANDARD_SQ=5) front_RPelvis,
				(select danger from bs_posestandard where POSESTANDARD_SQ=6) front_LPelvis,
				(select danger from bs_posestandard where POSESTANDARD_SQ=7) front_RLeg,
				(select danger from bs_posestandard where POSESTANDARD_SQ=8) front_LLeg,
				(select danger from bs_posestandard where POSESTANDARD_SQ=9) side_Neck,
				(select danger from bs_posestandard where POSESTANDARD_SQ=11) side_Shoulder,
				(select danger from bs_posestandard where POSESTANDARD_SQ=13) side_Pelvis,
				(select danger from bs_posestandard where POSESTANDARD_SQ=15) side_Leg
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$posestandard = json_encode($rows);

		// ROM 표준 데이터 
		$database->prepare("
			select 'caution' level, 
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=1) front_Neck_right,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=2) front_Neck_left,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=3) front_Shoulder_right,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=4) front_Shoulder_left,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=5) front_Waist_right,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=6) front_Waist_left,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=7) front_Hip_right,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=8) front_Hip_left,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=9) side_Neck_front,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=10) side_Neck_back,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=11) side_ShoulderL_front,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=12) side_ShoulderL_back,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=13) side_ShoulderR_front,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=14) side_ShoulderR_back,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=15) side_Waist_front,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=16) side_Waist_back,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=17) side_HipL_front,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=18) side_HipL_back,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=19) side_HipR_front,
				(select notbad_angle from bs_romstandard where ROMSTANDARD_SQ=20) side_HipR_back
			union
			select 'danger' level,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=1) front_Neck_right,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=2) front_Neck_left,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=3) front_Shoulder_right,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=4) front_Shoulder_left,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=5) front_Waist_right,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=6) front_Waist_left,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=7) front_Hip_right,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=8) front_Hip_left,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=9) side_Neck_front,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=10) side_Neck_back,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=11) side_ShoulderL_front,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=12) side_ShoulderL_back,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=13) side_ShoulderR_front,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=14) side_ShoulderR_back,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=15) side_Waist_front,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=16) side_Waist_back,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=17) side_HipL_front,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=18) side_HipL_back,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=19) side_HipR_front,
				(select bad_angle from bs_romstandard where ROMSTANDARD_SQ=20) side_HipR_back
		");
		$database->bind(':USER_SQ', $user_sq);
		$database->execute();

		$rows = $database->fetchAll();
		$romstandard = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($memberinfo.'|'.$inbodylist.'|'.$poselist.'|'.$romlist.'|'.$healthlist.'|'.$inbodydata.'|'.$posedata.'|'.$romdata.'|'.$healthdata.'|'.$posestandard.'|'.$romstandard.'|'.$posepicture);
		break;
	
	case 'getPoseData': // 사용자 리스트 취득 
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		// 파라메터 취득
		$MEASUREMENT_SQ = getAnyParameter("MEASUREMENT_SQ","");
		$CENTER_SQ = $session->user["CENTER_SQ"];

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$DEVICE_SQ = -1;
		$CATEGORY = "건강정보";
		$SUBCATEGORY = "자세측정정";
		$ACTION = $USERID . " 회원 자세측정정보를 조회하였습니다.";
		$IP = getClientIPv4();
		
		// 신체정보 리스트
		$database->prepare("
			select MEASUREMENT_SQ,USER_SQ,DEVICE_SQ,MEASUREMENT_TYPE,DONE,REG_DT
					from bs_measurement where DONE=1 AND MEASUREMENT_TYPE='INBODY' AND USER_SQ=:user_sq order by REG_DT DESC
		");
		$database->bind(':USER_SQ', $CENTER_SQ);
		$database->execute();

		$rows = $database->fetchAll();
		$inbodylist = json_encode($rows);
		
		// POSE 정보 리스트
		$database->prepare("
			select MEASUREMENT_SQ,USER_SQ,DEVICE_SQ,MEASUREMENT_TYPE,DONE,REG_DT
					from bs_measurement where DONE=1 AND MEASUREMENT_TYPE='Pose' AND USER_SQ=:user_sq order by REG_DT DESC
		");
		$database->bind(':USER_SQ', $CENTER_SQ);
		$database->execute();

		$rows = $database->fetchAll();
		$inbodylist = json_encode($rows);
		
		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($inbodylist.'|'.$inbodylist);
		break;

	case 'getUserList': // 사용자 리스트 취득 
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		// 파라메터 취득
		$CENTER_SQ = $session->user["CENTER_SQ"];

		// 기본값 설정
		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "멤버리스트";
		$SUBCATEGORY = "";
		$ACTION = "사용자 리스트를 조회하였습니다.";
		$IP = getClientIPv4();
		
		// DB 조회
		$database->prepare("
			select a.USER_SQ,a.CENTER_SQ,a.USER_NM,a.PHONE_NO,a.EMAIL,a.BIRTH_DT, a.REG_DT, (select REG_DT from bs_measurement where USER_SQ=a.USER_SQ order by REG_DT desc LIMIT 1) as MEAS_DATE
					,a.TRAINER, b.USER_NM TRAINER_NM
					from tb_user a  left outer join tb_user b on a.TRAINER=b.USER_SQ
					where a.CENTER_SQ=:CENTER_SQ and a.GRADE=1 order by a.REG_DT desc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();

		$rows = $database->fetchAll();
		$memberlist = json_encode($rows);

		$database->prepare("
			select USER_SQ,CENTER_SQ,USER_NM,PHONE_NO,EMAIL,REG_DT, (select REG_DT from bs_measurement where USER_SQ=tb_user.USER_SQ order by REG_DT desc LIMIT 1) as MEAS_DATE
					from tb_user where CENTER_SQ=:CENTER_SQ and GRADE>1 order by USER_NM desc
		");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->execute();

		$rows = $database->fetchAll();
		$trainerlist = json_encode($rows);

		// 로그 저장
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		exit($memberlist.'|'.$trainerlist);
		break;

	
	case 'staff_login': // 직원 로그인
		
		// 파라메터 취득
		$USERID = getAnyParameter("uID",0);
		$PASSWORD = getAnyParameter("uPW",0);
		$PWD_ENCRYPTED = getAnyParameter("pwd_encrypted",0);

		// 기본값 설정
		$USER_SQ = 0;
		$CATEGORY = "";
		$SUBCATEGORY = "";
		$ACTION = "";
		$DEVICE_SQ = -1;
		
		// DB 조회
		$database->prepare("
			SELECT USER_SQ, a.CENTER_SQ, USERID, USER_NM, c.NAME as GRADENM, BIRTH_DT, PHONE_NO, EMAIL, USERHEIGHT, USERWEIGHT, GRADE, b.CENTER_NM 
			FROM tb_user a left outer join tb_center b on a.CENTER_SQ=b.CENTER_SQ left outer join tb_common c on a.GRADE=c.CODE and c.BASE_CD='CD001'
			WHERE USERID = :USERID AND PWD_ENCRYPTED = :PWD_ENCRYPTED AND (ISUSE=1) AND a.GRADE>1
		");
		$database->bind(':USERID', $USERID);
		$database->bind(':PWD_ENCRYPTED', $PWD_ENCRYPTED);
		$database->execute();
		
		// 결과 처리
		$CATEGORY = "직원 로그인";
		$IP = getClientIPv4();

		$row = $database->fetch();
		if (!$row) {
			$redirect_location = 'login.php?msg=loginFailure';
			$SUBCATEGORY = "로그인 실패";
			$ACTION = "$IP PC에서 $USERID 사용자가 로그인에 실패하였습니다.";
		} else {
			if ($row["GRADE"]=='')
				$row["GRADE"]=='1';
			$SUBCATEGORY = "로그인 성공";
			$ACTION = "$IP PC에서 $USERID 사용자가 로그인에 성공하였습니다.";
			$USER_SQ = $row["USER_SQ"];
			$session->user = $row;
			$redirect_location = 'index.php'; // 로그인 이후 이동화면
		}
		// 로그 저장
		//insert_Log_Person($USER_SQ,$USERID, $IP, $DEVICE_SQ, $ACTION,$database);
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);
		//error_log("USERID = ".$USERID); //,3,"C:/xampp/debuggingLog/debug.log");
		//error_log("PASSWORD = ".$PASSWORD); //,3,"C:/xampp/debuggingLog/debug.log");
		break;
	
	case 'user_login': // 로그인
		// 파라메터 취득
		$USERID = getAnyParameter("uID",0);
		$PASSWORD = getAnyParameter("uPW",0);
		$PWD_ENCRYPTED = getAnyParameter("pwd_encrypted",0);

		// 기본값 설정
		$USER_SQ = 0;
		$CATEGORY = "";
		$SUBCATEGORY = "";
		$ACTION = "";
		$DEVICE_SQ = -1;
		
		// DB 조회
		$database->prepare("
			SELECT USER_SQ, a.CENTER_SQ, USERID, USER_NM, c.NAME as GRADENM, BIRTH_DT, PHONE_NO, EMAIL, USERHEIGHT, USERWEIGHT, GRADE, b.CENTER_NM 
			FROM tb_user a left outer join tb_center b on a.CENTER_SQ=b.CENTER_SQ left outer join tb_common c on a.GRADE=c.CODE and c.BASE_CD='CD001'
			WHERE USERID = :USERID AND PWD_ENCRYPTED = :PWD_ENCRYPTED AND (ISUSE=1)
		");
		$database->bind(':USERID', $USERID);
		$database->bind(':PWD_ENCRYPTED', $PWD_ENCRYPTED);
		$database->execute();
		
		// 결과 처리
		$CATEGORY = "회원로그인";
		$IP = getClientIPv4();

		$row = $database->fetch();
		if (!$row) {
			$redirect_location = 'login.php?msg=loginFailure';
			$SUBCATEGORY = "로그인 실패";
			$ACTION = "$IP PC에서 $USERID 사용자가 로그인에 실패하였습니다.";
		} else {
			if ($row["GRADE"]=='')
				$row["GRADE"]=='1';
			$SUBCATEGORY = "로그인 성공";
			$ACTION = "$IP PC에서 $USERID 사용자가 로그인에 성공하였습니다.";
			$USER_SQ = $row["USER_SQ"];
			$session->user = $row;
			$redirect_location = 'index.php'; // 로그인 이후 이동화면
		}
		// 로그 저장
		//insert_Log_Person($USER_SQ,$USERID, $IP, $DEVICE_SQ, $ACTION,$database);
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);
		//error_log("USERID = ".$USERID); //,3,"C:/xampp/debuggingLog/debug.log");
		//error_log("PASSWORD = ".$PASSWORD); //,3,"C:/xampp/debuggingLog/debug.log");
		break;

	case 'user_logout': // 로그아웃

		$USER_SQ = $session->user["USER_SQ"];
		$USERID = $session->user["USERID"];
		$DEVICE_SQ = -1;
		$CATEGORY = "로그아웃";
		$SUBCATEGORY = "";
		$ACTION = $session->user["USER_NM"] + " 사용자가 로그아웃하였습니다.";
		$IP = getClientIPv4();
		insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database);

		$session->destroy();
		$redirect_location = 'login.php'; // 로그아웃 이후 이동화면
		break;

		// OLD
	case 'user_register': // 사용자 등록 
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_FILES = ' . var_export($_FILES, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		$USER_SQ = $session->user["USER_SQ"];
		$CENTER_SQ = $session->user["CENTER_SQ"];

		$userid = getAnyParameter("userid", "");
		$pwd_encrypted = getAnyParameter("pwd_encrypted", "");
		$username = getAnyParameter("username", "");
		$birth = getAnyParameter("birth", "");
		$sex = getAnyParameter("sex", "");
		$tel = getAnyParameter("tel", "");
		$email = getAnyParameter("email", "");
		$person = getAnyParameter("person", "");
		$address = getAnyParameter("address", "");
		$comment = getAnyParameter("comment", "");
		$file_name["name"] = "";
			
		// File Manipulation
		if (isset($_FILES["myFileUp"]))
		{
			$upload_dir = "uploadfiles/";
			$upload_fileheader = $upload_dir."img_".date("YmdHis")."_";

			$upload_file = $upload_fileheader.str_replace(" ", "_", $_FILES["myFileUp"]["name"]);
			$filename=iconv("utf-8","CP949",$upload_file);
			$type = $_FILES["myFileUp"]["type"];
			$arr = explode('/',$type);

			if ($arr[0] == "image" && move_uploaded_file($_FILES["myFileUp"]["tmp_name"], $filename))
			{
				$file_name["name"] = $upload_file;
			}
		}
		$database->prepare("INSERT INTO tb_user (CENTER_SQ, USERID, PWD_ENCRYPTED, USER_NM, BIRTH_DT, GENDER, PHONE_NO, EMAIL, TRAINER, ADDRESS, COMMENT, GRADE, USERIMAGE, ISUSE, REG_DT ) 
					VALUES (:CENTER_SQ, :userid, :pwd_encrypted, :username, :birth, :sex, :tel, :email, :person, :address, :comment, 1, :filename, 1, now() ) 
					");
		$database->bind(':CENTER_SQ', $CENTER_SQ);
		$database->bind(':userid', $userid);
		$database->bind(':pwd_encrypted', $pwd_encrypted);
		$database->bind(':username', $username);
		$database->bind(':birth', $birth);
		$database->bind(':sex', $sex);
		$database->bind(':tel', $tel);
		$database->bind(':email', $email);
		$database->bind(':person', $person);
		$database->bind(':address', $address);
		$database->bind(':comment', $comment);
		$database->bind(':filename', $file_name["name"]);
		
		$database->execute();
		if ($database->rowCount() > 0) {
			$redirect_location = 'index.php?member_register=success'; // 로그아웃 이후 이동화면
		}
		else {
			$redirect_location = 'index.php?member_register=fail'; // 로그아웃 이후 이동화면
		}
		
		$USER_SQ = $session->user["USER_SQ"];
		$DEVICE_SQ = -1;
		$ACTION = "사용자 신규 등록";
		$IP = getClientIPv4();
		insert_Log_Person($USER_SQ,$userid, $IP, $DEVICE_SQ, $ACTION,$database);
		
		break;

	case 'UserActionReport': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		
		$sdate = getAnyParameter("dpuserreportSDate",0);
		$edate = getAnyParameter("dpuserreportEDate",0);
		$userid = getAnyParameter("userreportID",0);

		$database->prepare("	select @ROWNUM := @ROWNUM + 1 AS no, date_format(a.regdt, '%Y-%m-%d %H:%i:%s') regdt  
									,a.ip ,a.t_ip ,a.note ,a.regid 
									,(select name from tb_jang where ip = a.IP) name 
									,(select name from tb_person where id = a.id) person 
									,(select name from tb_jang where ip = a.t_IP) t_name 
									,(select name from tb_person where id = a.regid) reg_person 
								from tb_log_person a , (SELECT @ROWNUM := 0) R 
								where (:regid1='' or a.regid = :regid2) 
									and (:sdate1='' or date_format(a.regdt, '%Y-%m-%d') between :sdate2 and :edate)
								order by a.regdt asc, a.regid asc 
						");
		$database->bind(':regid1', $userid);
		$database->bind(':regid2', $userid);
		$database->bind(':sdate1', $sdate);
		$database->bind(':sdate2', $sdate);
		$database->bind(':edate', $edate);
		$database->execute();
		$rows = $database->fetchAll();

		require_once './lib/PHPExcel.php';
		require_once './lib/PHPExcel/IOFactory.php';

	
		$objPHPExcel = new PHPExcel();
		$objPHPExcel->getProperties()
			->setCreator("5훈비")
			->setLastModifiedBy("5훈비")
			->setTitle("사용자 이력 보고서")
			->setSubject("사용자 이력 보고서")
			->setDescription("주기장관제시스템")
			->setKeywords("사용자 이력 보고서")
			->setCategory("사용자 이력 보고서");
		// 타이틀 
		$ind = 1;
		$sheet = $objPHPExcel->setActiveSheetIndex(0);
		$sheet->setTitle( '사용자' );
		$sheet->setCellValue("A$ind", "사용자 이력 보고서");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->mergeCells("A$ind:F$ind");
		$sheet->getStyle("A$ind")->getFont()->setUnderline(PHPExcel_Style_Font::UNDERLINE_SINGLE);
		$sheet->getStyle("A$ind")->getFont()->setSize(16);
		// 출력자, 출력일. 
		$ind++;
		$sheet->setCellValue("A$ind", "출력자");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		$sheet->setCellValue("B$ind", $session->user['name']);
		$sheet->getStyle("B$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
		$sheet->mergeCells("B$ind:I$ind");
		$ind++;
		$sheet->setCellValue("A$ind", "출력일");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		$sheet->setCellValue("B$ind", date("Y/m/d"));
		$sheet->getStyle("B$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
		$sheet->mergeCells("B$ind:I$ind");

		$ind++;$ind++;
		$sheet->setCellValue("A$ind", "번호");
		$sheet->setCellValue("B$ind", "사용PC");
		$sheet->setCellValue("C$ind", "사용자");
		$sheet->setCellValue("D$ind", "설정장비");
		$sheet->setCellValue("E$ind", "내용");
		$sheet->setCellValue("F$ind", "수정일자");
		$sheet->getStyle("A$ind:F$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind:F$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		
		//$objPHPExcel->getActiveSheet()->getStyle( 'A4:E10')->applyFromArray(getExcelFontArray())
		//function getExcelFontArray($size, $bold, $underline, $color)
		//function getExcelFillArray($color)
		//function getExcelBorderArray($color)
		$ind++;
		foreach ($rows as $row)
		{
			$sheet->setCellValue("A$ind", $row["no"]);
			$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$sheet->setCellValue("B$ind", $row["name"]);
			$sheet->setCellValue("C$ind", $row["regid"]);
			$sheet->setCellValue("D$ind", $row["t_name"]);
			$sheet->setCellValue("E$ind", $row["note"]);
			$sheet->setCellValue("F$ind", $row["regdt"]);
			
			$sheet->getStyle("F$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$ind++;
		}
		$sheet->getColumnDimension('A')->setWidth(10);
		$sheet->getColumnDimension('B')->setWidth(25);
		$sheet->getColumnDimension('C')->setWidth(12);
		$sheet->getColumnDimension('D')->setWidth(18);
		$sheet->getColumnDimension('E')->setWidth(40);
		$sheet->getColumnDimension('F')->setAutoSize(true); 
		
		//$objPHPExcel->setActiveSheetIndex(0);
		//$sheet->setSelectedCellByColumnAndRow(0, 1);

		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');

		header("Pragma:public");
		header('Content-Description: File Transfer');
		//header("Content-Type: application/octet-stream");
		header("Content-Type: application/vnd.ms-excel;");
		if (preg_match("/MSIE/i", getenv("HTTP_USER_AGENT")))
		{
			header('Content-Disposition: filename=사용자이력보고서.xls');// 파일이름 설정
		} else 
		{
			header('Content-Disposition: filename=사용자이력보고서.xls');// 파일이름 설정
		}
		ob_clean();
		flush();
		//header('Content-Length: ' . filesize('result.xls'));
		//header('Cache-Control: max-age=0');
		//readfile('result.xls');
		$objWriter->save('php://output');

		
		$regid = $session->user["id"];
		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "사용자 이력 출력", $database);
		exit;
		break;

	case 'EquipListReport': // ajax - select optionbox 를 채운다.
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		
		$gucd = getAnyParameter("EquipListReport_GUCD",0);

		$database->prepare("	select @ROWNUM := @ROWNUM + 1 AS NO, seq, gucd, pow, icon, connect, fin, useyn
								,(select name from tb_code where gucd = 'J1' and cdcd = a.gucd) as gunm
								, ip, id, name, p_x, p_y, dist, t_r, t_rp, note
								, pow, connect, fin, useyn, ca_hei, d_t, d_st, d_et, cell, tilt
								,if(pow = '1', 'ON', 'OFF') as pow_st
								,if(connect = '1', '정상', '장애') as connect_st
								,if(fin = '1', '탐지', '미탐지') as fin_st
								,if(useyn = 'Y', '사용', '미사용') as usenm
								,case when d_t = '1' or d_t = '2' then '감지' else '배제' end as d_tnm 
								,date_format(a.updt, '%Y-%m-%d %H:%i:%s') updt
								from tb_jang a, (SELECT @ROWNUM := 0) R
								where (:eventequip = 0 or a.gucd = :eventequip1) 
								order by gucd asc, name asc
						");
		$database->bind(':eventequip', $gucd);
		$database->bind(':eventequip1', $gucd);
		$database->execute();
		$rows = $database->fetchAll();

		require_once './lib/PHPExcel.php';
		require_once './lib/PHPExcel/IOFactory.php';
	
		$objPHPExcel = new PHPExcel();
		$objPHPExcel->getProperties()
			->setCreator("5훈비")
			->setLastModifiedBy("5훈비")
			->setTitle("장비 관리 내역 보고서")
			->setSubject("장비 관리 내역 보고서")
			->setDescription("주기장관제시스템")
			->setKeywords("장비 관리 내역 보고서")
			->setCategory("장비 관리 내역 보고서");
		// 타이틀 
		$ind = 1;
		$sheet = $objPHPExcel->setActiveSheetIndex(0);
		$sheet->setTitle( '장비' );
		$sheet->setCellValue("A$ind", "장비 관리 내역 보고서");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->mergeCells("A$ind:I$ind");
		$sheet->getStyle("A$ind")->getFont()->setUnderline(PHPExcel_Style_Font::UNDERLINE_SINGLE);
		$sheet->getStyle("A$ind")->getFont()->setSize(16);
		// 출력자, 출력일. 
		$ind++;
		$sheet->setCellValue("A$ind", "출력자");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		$sheet->setCellValue("B$ind", $session->user['name']);
		$sheet->getStyle("B$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
		$sheet->mergeCells("B$ind:I$ind");
		$ind++;
		$sheet->setCellValue("A$ind", "출력일");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		$sheet->setCellValue("B$ind", date("Y/m/d"));
		$sheet->getStyle("B$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
		$sheet->mergeCells("B$ind:I$ind");

		$ind++;$ind++;
		$sheet->setCellValue("A$ind", "번호");
		$sheet->setCellValue("B$ind", "IP");
		$sheet->setCellValue("C$ind", "감시지역");
		$sheet->setCellValue("D$ind", "장비");
		$sheet->setCellValue("E$ind", "장비명");
		$sheet->setCellValue("F$ind", "설치좌표");
		$sheet->setCellValue("G$ind", "수정일자");
		$sheet->setCellValue("H$ind", "전원");
		$sheet->setCellValue("I$ind", "연결상태");
		$sheet->getStyle("A$ind:I$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind:I$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		
		//$objPHPExcel->getActiveSheet()->getStyle( 'A4:E10')->applyFromArray(getExcelFontArray())
		//function getExcelFontArray($size, $bold, $underline, $color)
		//function getExcelFillArray($color)
		//function getExcelBorderArray($color)
		$ind++;
		foreach ($rows as $row)
		{
			$sheet->setCellValue("A$ind", $row["NO"]);
			$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$sheet->setCellValue("B$ind", $row["ip"]);
			$sheet->setCellValue("C$ind", $row["note"]);
			$sheet->setCellValue("D$ind", $row["gunm"]);
			$sheet->setCellValue("E$ind", $row["name"]);
			if ($row["p_x"]=="")
				$sheet->setCellValue("F$ind", "");
			else {
				$sheet->setCellValue("F$ind", $row["p_x"].", ".$row["p_y"]);
			}
			$sheet->getStyle("F$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$sheet->setCellValue("G$ind", $row["updt"]);
			$sheet->getStyle("G$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$sheet->setCellValue("H$ind", $row["pow_st"]);
			$sheet->getStyle("H$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			if ($row["connect"]=="1")
				$sheet->setCellValue("I$ind", "정상");
			else if ($row["connect"]=="2")
				$sheet->setCellValue("I$ind", "장애");
			else
				$sheet->setCellValue("I$ind", "");
			$sheet->getStyle("I$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$ind++;
		}
		$sheet->getColumnDimension('A')->setWidth(10);
		$sheet->getColumnDimension('B')->setAutoSize(true); 

		//$sheet->getColumnDimension('C')->setAutoSize(true); 
		//$sheet->calculateColumnWidths();
		//$calculatedWidth = round( $sheet->getColumnDimensionByColumn('C')->getWidth(), 0 );
		//error_log('$calculatedWidth = ' . $calculatedWidth);
		//$sheet->getColumnDimension('C')->setAutoSize(false); 
		//$calculatedWidth2 = round( $sheet->getColumnDimensionByColumn('C')->getWidth(), 0 );
		//error_log('calculatedWidth2 = ' . $calculatedWidth2);
		//if( $calculatedWidth < 9 ) {
		//	$sheet->getColumnDimensionByColumn('C')->setWidth( round(1.8*$calculatedWidth, 0) );
		//}
		$sheet->getColumnDimension('C')->setWidth(48);
		$sheet->getColumnDimension('D')->setWidth(15);
		$sheet->getColumnDimension('E')->setWidth(19);
		$sheet->getColumnDimension('F')->setAutoSize(true); 
		$sheet->getColumnDimension('G')->setAutoSize(true); 
		$sheet->getColumnDimension('H')->setWidth(imap_utf7_encode());
		$sheet->getColumnDimension('I')->setWidth(13);
		
		//$objPHPExcel->setActiveSheetIndex(0);
		//$sheet->setSelectedCellByColumnAndRow(0, 1);

		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');

		header("Pragma:public");
		header('Content-Description: File Transfer');
		//header("Content-Type: application/octet-stream");
		header("Content-Type: application/vnd.ms-excel;");
		if (preg_match("/MSIE/i", getenv("HTTP_USER_AGENT")))
		{
			header('Content-Disposition: filename=장비관리내역보고서.xls');// 파일이름 설정
		} else 
		{
			header('Content-Disposition: filename=장비관리내역보고서.xls');// 파일이름 설정
		}
		ob_clean();
		flush();
		//header('Content-Length: ' . filesize('result.xls'));
		//header('Cache-Control: max-age=0');
		//readfile('result.xls');
		$objWriter->save('php://output');

		$regid = $session->user["id"];
		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "시스템 장비내역 출력", $database);
		exit;
		break;

	case 'EventReport': // ajax - select optionbox 를 채운다.
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		
		$sdate = getAnyParameter("dpeventreportSDate",0);
		$edate = getAnyParameter("dpeventreportEDate",0);
		$eventequip = getAnyParameter("eventreportequip",0);
		$eventtype = getAnyParameter("eventreporttype",0);

		$database->prepare("	select a.* 
									,if(a.gucd = '1' ,(SELECT p_x FROM  tb_log_fin_pt c WHERE a.ip = c.ip AND a.gro = c.GRO ORDER BY NO ASC LIMIT 1), '') s_p_x
									,if(a.gucd = '1' ,(SELECT p_y FROM  tb_log_fin_pt c WHERE a.ip = c.ip AND a.gro = c.GRO order BY NO ASC LIMIT 1), '') s_p_y 
									,if(a.gucd = '1' ,(SELECT p_x FROM  tb_log_fin_pt c WHERE a.ip = c.ip AND a.gro = c.GRO ORDER BY NO DESC LIMIT 1), '') e_p_x 
									,if(a.gucd = '1' ,(SELECT p_y FROM  tb_log_fin_pt c WHERE a.ip = c.ip AND a.gro = c.GRO order BY NO DESC LIMIT 1), '') e_p_y 
									,if(a.gucd = '1' ,(SELECT speed FROM  tb_log_fin_pt c WHERE a.ip = c.ip AND a.gro = c.GRO order BY NO DESC LIMIT 1), '') speed 
								from ( select @ROWNUM := @ROWNUM + 1 AS NO ,a.seq ,date_format(a.regdt, '%Y-%m-%d %H:%i:%s') regdt ,date_format(a.updt, '%Y-%m-%d %H:%i:%s') updt 
										,b.name as na2 ,b.note as na3 ,a.ip ,a.id ,a.gro ,a.note ,a.result ,(select name from tb_code where gucd = 'R1' and cdcd = a.result) as resultnm 
										,a.upid ,(SELECT NAME FROM tb_person WHERE a.upid = id) upnm ,(SELECT NAME FROM tb_code WHERE gucd = 'J1' and cdcd = b.gucd) as na1 ,b.gucd 
									from tb_log_fin a, tb_jang b , (SELECT @ROWNUM := 0) R 
									where a.useyn = 'Y' and a.ip = b.ip  and ((:sdate = '' or :edate = '') or date_format(a.regdt, '%Y-%m-%d') between :sdate1 and :edate1)
										and (:eventequip = 0 or b.gucd = :eventequip1) 
										and (:eventtype = 2 or a.result = :eventtype1)
									order by a.regdt asc )as a 
						");
		$database->bind(':sdate', $sdate);
		$database->bind(':edate', $edate);
		$database->bind(':sdate1', $sdate);
		$database->bind(':edate1', $edate);
		$database->bind(':eventequip', $eventequip);
		$database->bind(':eventequip1', $eventequip);
		$database->bind(':eventtype', $eventtype);
		$database->bind(':eventtype1', $eventtype);
		$database->execute();
		$rows = $database->fetchAll();

		require_once './lib/PHPExcel.php';
		require_once './lib/PHPExcel/IOFactory.php';

		$ind = 1;
		$objPHPExcel = new PHPExcel();
		$objPHPExcel->getProperties()
			->setCreator("5훈비")
			->setLastModifiedBy("5훈비")
			->setTitle("경보상황 보고서")
			->setSubject("경보상황 보고서")
			->setDescription("주기장관제시스템")
			->setKeywords("경보상황 보고서")
			->setCategory("경보상황 보고서");
		// 타이틀 
		$sheet = $objPHPExcel->setActiveSheetIndex(0);
		$sheet->setTitle( '이벤트' );
		$sheet->setCellValue("A$ind", "경보상황 일일 보고서");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->mergeCells("A$ind:K$ind");
		$sheet->getStyle("A$ind")->getFont()->setUnderline(PHPExcel_Style_Font::UNDERLINE_SINGLE);
		$sheet->getStyle("A$ind")->getFont()->setSize(16);
		// 출력자, 출력일. 
		$ind++;
		$sheet->setCellValue("A$ind", "출력자");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		$sheet->setCellValue("B$ind", $session->user['name']);
		$sheet->getStyle("B$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
		$sheet->mergeCells("B$ind:K$ind");
		$ind++;
		$sheet->setCellValue("A$ind", "출력일");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		$sheet->setCellValue("B$ind", date("Y/m/d"));
		$sheet->getStyle("B$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
		$sheet->mergeCells("B$ind:K$ind");
		$ind++;
		$sheet->setCellValue("A$ind", "기간");
		$sheet->getStyle("A$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		$sheet->setCellValue("B$ind", "$sdate~$edate");
		$sheet->getStyle("B$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);
		$sheet->mergeCells("B$ind:K$ind");

		$ind++;$ind++;
		$sheet->setCellValue("A$ind", "번호");
		$sheet->setCellValue("B$ind", "발생일시");
		$sheet->setCellValue("C$ind", "조치일시");
		$sheet->setCellValue("D$ind", "감지지역");
		$sheet->setCellValue("E$ind", "장비");
		$sheet->setCellValue("F$ind", "장비명");
		$sheet->setCellValue("G$ind", "감시좌표");
		$sheet->setCellValue("H$ind", "속도");
		$sheet->setCellValue("I$ind", "조치내용");
		$sheet->setCellValue("J$ind", "처리");
		$sheet->setCellValue("K$ind", "담당자");
		$sheet->getStyle("A$ind:K$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
		$sheet->getStyle("A$ind:K$ind")->applyFromArray(getExcelFillArray('b2beb5'));
		
		//$objPHPExcel->getActiveSheet()->getStyle( 'A4:E10')->applyFromArray(getExcelFontArray())
		//function getExcelFontArray($size, $bold, $underline, $color)
		//function getExcelFillArray($color)
		//function getExcelBorderArray($color)
		$ind++;
		foreach ($rows as $row)
		{
			$sheet->setCellValue("A$ind", $row["NO"]);
			$sheet->setCellValue("B$ind", $row["regdt"]);
			$sheet->setCellValue("C$ind", $row["updt"]);
			$sheet->getStyle("A$ind:C$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$sheet->setCellValue("D$ind", $row["na3"]);
			$sheet->setCellValue("E$ind", $row["na1"]);
			$sheet->setCellValue("F$ind", $row["na2"]);
			if ($row["s_p_x"]=="")
				$sheet->setCellValue("G$ind", "");
			else {
				$sheet->setCellValue("G$ind", $row["s_p_x"].", ".$row["s_p_y"]."  ->  ".$row["e_p_x"].", ".$row["e_p_y"]);
			}
			$sheet->getStyle("G$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$sheet->setCellValue("H$ind", $row["speed"]);
			$sheet->setCellValue("I$ind", $row["note"]);
			$sheet->setCellValue("J$ind", $row["resultnm"]);
			$sheet->getStyle("J$ind")->getAlignment()->setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);
			$sheet->setCellValue("K$ind", $row["upid"]);
			$ind++;
		}
		$sheet->getColumnDimension('A')->setWidth(10);
		$sheet->getColumnDimension('B')->setAutoSize(true); 
		$sheet->getColumnDimension('C')->setAutoSize(true); 
		$sheet->getColumnDimension('D')->setWidth(48);
		$sheet->getColumnDimension('E')->setWidth(25);
		$sheet->getColumnDimension('F')->setWidth(18);
		$sheet->getColumnDimension('G')->setAutoSize(true); 
		$sheet->getColumnDimension('H')->setWidth(7);
		$sheet->getColumnDimension('I')->setWidth(20);
		$sheet->getColumnDimension('J')->setWidth(12);
		$sheet->getColumnDimension('K')->setWidth(11);
		
		//$objPHPExcel->setActiveSheetIndex(0);
		//$sheet->setSelectedCellByColumnAndRow(0, 1);

		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');

		header("Pragma:public");
		header('Content-Description: File Transfer');
		//header("Content-Type: application/octet-stream");
		header("Content-Type: application/vnd.ms-excel;");
		if (preg_match("/MSIE/i", getenv("HTTP_USER_AGENT")))
		{
			header('Content-Disposition: filename=경보상황보고서.xls');// 파일이름 설정
		} else 
		{
			header('Content-Disposition: filename=경보상황보고서.xls');// 파일이름 설정
		}
		ob_clean();
		flush();
		//header('Content-Length: ' . filesize('result.xls'));
		//header('Cache-Control: max-age=0');
		//readfile('result.xls');
		$objWriter->save('php://output');
		
		$regid = $session->user["id"];
		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "경보상황 보고서 출력", $database);
		exit;
		break;
		
	case 'SettingSave': // ajax - select optionbox 를 채운다.
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}

		$seq = getAnyParameter("seq","");
		$rimg_r = getAnyParameter("rimg_r","");
		$rimg_fp = getAnyParameter("rimg_fp","");
		$rimg_fl = getAnyParameter("rimg_fl","");
		$rimg_o = getAnyParameter("rimg_o","");
		$rimg_index = getAnyParameter("rimg_index","");
		$rimg_ac = getAnyParameter("rimg_ac","");
		$rimg_unc = getAnyParameter("rimg_unc","");
		$simg_r = getAnyParameter("simg_r","");
		$simg_ac = getAnyParameter("simg_ac","");
		$cimg_r = getAnyParameter("cimg_r","");
		$cimg_o = getAnyParameter("cimg_o","");
		$cimg_ac = getAnyParameter("cimg_ac","");
		$ss_m = getAnyParameter("ss_m","");
		$se_m = getAnyParameter("se_m","");
		$ss_t = getAnyParameter("ss_t","");
		$se_t = getAnyParameter("se_t","");
		$ws_m = getAnyParameter("ws_m","");
		$we_m = getAnyParameter("we_m","");
		$ws_t = getAnyParameter("ws_t","");
		$we_t = getAnyParameter("we_t","");

		error_log("ast : " . $ast);
		$regid = $session->user["id"];
		
		$database->prepare("update tb_pc_set set  
								rimg_r = :rimg_r, rimg_fp = :rimg_fp, rimg_fl = :rimg_fl, rimg_o = :rimg_o,  rimg_index = :rimg_index,  rimg_ac = :rimg_ac, rimg_unc = :rimg_unc, 
								simg_r = :simg_r, simg_ac = :simg_ac, cimg_r = :cimg_r, cimg_o = :cimg_o,  cimg_ac = :cimg_ac, 
								ss_m = :ss_m, se_m = :se_m, ss_t = :ss_t, se_t = :se_t,  ws_m = :ws_m,  we_m = :we_m,  ws_t = :ws_t,  we_t = :we_t, 
								upid = :upid, updt = now() 
							where seq = :seq
						");
		$database->bind(':rimg_r', $rimg_r);
		$database->bind(':rimg_fp', $rimg_fp);
		$database->bind(':rimg_fl', $rimg_fl);
		$database->bind(':rimg_o', $rimg_o);
		$database->bind(':rimg_index', $rimg_index);
		$database->bind(':rimg_ac', $rimg_ac);
		$database->bind(':rimg_unc', $rimg_unc);
		$database->bind(':simg_r', $simg_r);
		$database->bind(':simg_ac', $simg_ac);
		$database->bind(':cimg_r', $cimg_r);
		$database->bind(':cimg_o', $cimg_o);
		$database->bind(':cimg_ac', $cimg_ac);
		$database->bind(':ss_m', $ss_m);
		$database->bind(':se_m', $se_m);
		$database->bind(':ss_t', $ss_t);
		$database->bind(':se_t', $se_t);
		$database->bind(':ws_m', $ws_m);
		$database->bind(':we_m', $we_m);
		$database->bind(':ws_t', $ws_t);
		$database->bind(':we_t', $we_t);
		$database->bind(':upid', $regid);
		$database->bind(':seq', $seq);
		$database->execute();

		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "환경 저장", $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;
		
	case 'EquipIconChange': // ajax - select optionbox 를 채운다.
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		$seq = getAnyParameter("seq","");
		$gucd = getAnyParameter("gucd","");
		$t_ip = getAnyParameter("ip","");
		$icon = getAnyParameter("icon","");

		$regid = $session->user["id"];
		
		$database->prepare("update tb_jang set  
								icon = :icon, 
								upid = :upid, updt = now() 
							where seq = :seq
						");
		$database->bind(':icon', $icon);
		$database->bind(':upid', $regid);
		$database->bind(':seq', $seq);

		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = $t_ip;
		$reason = "";
		if ($gucd=="1")
		{
			$reason = "레이더 아이콘 수정";
		} else if ($gucd=="2")
		{
			$reason = "복합센서 아이콘 수정";
		} else if ($gucd=="3")
		{
			$reason = "카메라 아이콘 수정";
		} else if ($gucd=="4")
		{
			$reason = "경광등 아이콘 수정";
		} else if ($gucd=="5")
		{
			$reason = "서치라이트 아이콘 수정";
		}
		insert_Log_Person($regid, $ip, $t_ip, $reason, $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;
		
	case 'EquipIconAll': // ajax - select optionbox 를 채운다.
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		$gucd = getAnyParameter("gucd","");
		$icon = getAnyParameter("icon","");

		$regid = $session->user["id"];
		
		$database->prepare("update tb_jang set  
								icon = :icon, 
								upid = :upid, updt = now() 
							where gucd = :gucd
						");
		$database->bind(':icon', $icon);
		$database->bind(':upid', $regid);
		$database->bind(':gucd', $gucd);

		$database->execute();
		
		error_log($gucd);
		error_log($icon);
		error_log($regid);
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		$reason = "";
		if ($gucd=="1")
		{
			$reason = "레이더 아이콘 일괄 수정";
		} else if ($gucd=="2")
		{
			$reason = "복합센서 아이콘 일괄 수정";
		} else if ($gucd=="3")
		{
			$reason = "카메라 아이콘 일괄 수정";
		} else if ($gucd=="4")
		{
			$reason = "경광등 아이콘 일괄 수정";
		} else if ($gucd=="5")
		{
			$reason = "서치라이트 아이콘 일괄 수정";
		}
		insert_Log_Person($regid, $ip, $t_ip, $reason, $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;
		
	case 'AlarmSave': // ajax - select optionbox 를 채운다.
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		$seq = getAnyParameter("seq","");
		$al = getAnyParameter("al","");
		$rimg_aec = getAnyParameter("rimg_aec","");
		$simg_aec = getAnyParameter("simg_aec","");
		$at = getAnyParameter("at","");
		$asv = getAnyParameter("asv","");
		$ast = getAnyParameter("ast","");

		error_log("ast : " . $ast);
		$regid = $session->user["id"];
		
		$database->prepare("update tb_pc_set set  
								al = :al, rimg_aec = :rimg_aec, simg_aec = :simg_aec, at = :at,  asv = :asv,  ast = :ast, 
								upid = :upid, updt = now() 
							where seq = :seq
						");
		$database->bind(':al', $al);
		$database->bind(':rimg_aec', $rimg_aec);
		$database->bind(':simg_aec', $simg_aec);
		$database->bind(':at', $at);
		$database->bind(':asv', $asv);
		$database->bind(':ast', $ast);
		$database->bind(':upid', $regid);
		$database->bind(':seq', $seq);
		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "이벤트알림 설정 수정", $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;
		
	case 'CodeDelete': // ajax - select optionbox 를 채운다.
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		$gucd = getAnyParameter("gucd","");
		$cdcd = getAnyParameter("cdcd","");

		error_log("gucd : " . $gucd);
		error_log("cdcd : " . $cdcd);
		$regid = $session->user["id"];
		
		$database->prepare("delete from tb_code 
							where gucd = :gucd and cdcd = :cdcd 
						");
		$database->bind(':gucd', $gucd);
		$database->bind(':cdcd', $cdcd);
		$database->execute();
		
		error_log("rowCount : " . $database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "기초코드 삭제", $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;

	case 'CodeEdit': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
	// db field gucd, note, cdcd, name, odby, useyn, if(useyn = 'Y', '사용', '미사용') as usenm 
		$gucd = getAnyParameter("gucd","");
		$note = getAnyParameter("note","");
		$cdcd = getAnyParameter("cdcd","");
		$name = getAnyParameter("name","");
		$odby = getAnyParameter("odby","");
		$useyn = getAnyParameter("useyn","");

		error_log("cdcd : " . $cdcd);
		$regid = $session->user["id"];
		
		$database->prepare("update tb_code set 
								note = :note, name = :name, useyn = :useyn, odby = :odby, upid = :upid, updt = now() 
							where gucd = :gucd and cdcd = :cdcd 
						");
		$database->bind(':note', $note);
		$database->bind(':name', $name);
		$database->bind(':useyn', $useyn);
		$database->bind(':odby', $odby);
		$database->bind(':upid', $regid);
		$database->bind(':gucd', $gucd);
		$database->bind(':cdcd', $cdcd);
		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "기초코드 수정", $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;
		
	case 'CodeSave': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
	// db field gucd, note, cdcd, name, odby, useyn, if(useyn = 'Y', '사용', '미사용') as usenm 
		$gucd = getAnyParameter("gucd","");
		$note = getAnyParameter("note","");
		$cdcd = getAnyParameter("cdcd","");
		$name = getAnyParameter("name","");
		$odby = getAnyParameter("odby","");
		$useyn = getAnyParameter("useyn","");

		error_log("cdcd : " . $cdcd);
		$regid = $session->user["id"];
		
		$database->prepare("insert into tb_code( gucd, note, cdcd, name, useyn, odby, regid, regdt )
								values ( :gucd, :note, :cdcd, :name, :useyn, :odby, :regid, now() )
						");
		$database->bind(':note', $note);
		$database->bind(':name', $name);
		$database->bind(':useyn', $useyn);
		$database->bind(':odby', $odby);
		$database->bind(':regid', $regid);
		$database->bind(':gucd', $gucd);
		$database->bind(':cdcd', $cdcd);
		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "기초코드 등록", $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;
		
	case 'UserDelete': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$id = getAnyParameter("id","");

		error_log("id : " . $id);
		$regid = $session->user["id"];
		
		$database->prepare("update tb_person set useyn = 'N', delid = :delid, deldt = now() 
							where id=:id
						");
		$database->bind(':id', $id);
		$database->bind(':delid', $regid);
		$database->execute();
		
		error_log("rowCount : " . $database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "사용자 삭제", $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;

	case 'UserEdit': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
	// db field id, name, belong, class, power,useyn , pwchange

		$id = getAnyParameter("id","");
		$name = getAnyParameter("name","");
		$belong = getAnyParameter("belong","");
		$class = getAnyParameter("class","");
		$power = getAnyParameter("power","");
		$useyn = getAnyParameter("useyn","");
		$pwd = getAnyParameter("pwd","");
		$pwchange = getAnyParameter("pwchange","");

		error_log("id : " . $id);
		$regid = $session->user["id"];
		
		if ($pwchange == "true")
		{
			$database->prepare("update tb_person set name=:name, pwd=:pwd, class=:class, power=:power,
											belong = :belong, upid = :upid, updt = now()
									where id = :id
							");
			$database->bind(':pwd', $pwd);
		} else 
		{
			$database->prepare("update tb_person set name=:name, class=:class, power=:power,
											belong = :belong, upid = :upid, updt = now()
									where id = :id
							");
		}
		$database->bind(':id', $id);
		$database->bind(':name', $name);
		$database->bind(':class', $class);
		$database->bind(':belong', $belong);
		$database->bind(':power', $power);
		$database->bind(':upid', $regid);
		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "사용자 수정", $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;
		

	case 'UserSave': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
	// db field id, name, belong, class, power,useyn , pwchange

		$id = getAnyParameter("id","");
		$name = getAnyParameter("name","");
		$belong = getAnyParameter("belong","");
		$class = getAnyParameter("class","");
		$power = getAnyParameter("power","");
		$useyn = getAnyParameter("useyn","");
		$pwd = getAnyParameter("pwd","");
		$pwchange = getAnyParameter("pwchange","");

		error_log("id : " . $id);
		$regid = $session->user["id"];
		
		$database->prepare("insert into tb_person( id, name, pwd, class, belong, power, useyn, regid, regdt ) values
							(:id, :name, :pwd, :class, :belong, :power, 'Y', :regid, now() )
						");
		$database->bind(':id', $id);
		$database->bind(':name', $name);
		$database->bind(':pwd', $pwd);
		$database->bind(':class', $class);
		$database->bind(':belong', $belong);
		$database->bind(':power', $power);
		$database->bind(':regid', $regid);
		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "사용자 추가", $database);
		error_log(json_encode($response_array));
		exit(json_encode($response_array));
		break;
		
	case 'ExceptDelete': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$delete = getAnyParameter("delete","");
		error_log('delete = ' . var_export($delete, 1));
		$regid = $session->user["id"];
		
		if ($delete!="")
		{
			for ($i=0;$i<count($delete);$i++)
			{
				$database->prepare("delete from tb_jang_pt 
									where ip = :ip and n = :n and disp = 'N'
								");
				$database->bind(':ip', $delete[$i]["ip"]);
				$database->bind(':n', $delete[$i]["n"]);
				$database->execute();
				error_log('delete = ' . $database->rowCount());
				error_log('$delete[$i][ip] = ' .$delete[$i]["ip"]);
				error_log('$delete[$i][n] = ' . $delete[$i]["n"]);
			}
		}

		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		error_log(json_encode($response_array));
		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "배제구역 삭제", $database);
		exit(json_encode($response_array));
		break;
		
	case 'ExceptSave': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$update = getAnyParameter("update","");
		$insert = getAnyParameter("insert","");
		error_log('$update = ' . var_export($update, 1));
		error_log('$insert = ' . var_export($insert, 1));
		$regid = $session->user["id"];
		if ($update!="")
		{
			for ($i=0;$i<count($update);$i++)
			{
				$database->prepare("update tb_jang_pt set  name=:name, useyn=:useyn, 
											upid = :upid, updt = now()
									where ip = :ip and n = :n and disp = :disp
								");
				$database->bind(':name', $update[$i]["name"]);
				$database->bind(':useyn', $update[$i]["useyn"]);
				$database->bind(':upid', $regid);
				$database->bind(':ip', $update[$i]["ip"]);
				$database->bind(':n', $update[$i]["n"]);
				$database->bind(':disp', $update[$i]["disp"]);
				$database->execute();
			}
		}
		if ($insert!="")
		{
			for ($i=0;$i<count($insert);$i++)
			{
				$database->prepare("insert into tb_jang_pt( name, useyn, ip, p_x, p_y, n, ord, disp, regid, regdt )
										values ( :name, :useyn, :ip, :p_x, :p_y, :n, :ord, :disp, :regid, now() )
								");
				$database->bind(':name', $insert[$i]["name"]);
				$database->bind(':useyn', $insert[$i]["useyn"]);
				$database->bind(':ip', $insert[$i]["ip"]);
				$database->bind(':p_x', $insert[$i]["p_x"]);
				$database->bind(':p_y', $insert[$i]["p_y"]);
				$database->bind(':n', $insert[$i]["n"]);
				$database->bind(':ord', $insert[$i]["ord"]);
				$database->bind(':disp', $insert[$i]["disp"]);
				$database->bind(':regid', $regid);
				$database->execute();
			}
		}

		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		error_log(json_encode($response_array));
		$ip = getClientIPv4();
		$t_ip = "";
		insert_Log_Person($regid, $ip, $t_ip, "배제구역 저장", $database);
		exit(json_encode($response_array));
		break;

	case 'EventLogResultSave': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$seq = getAnyParameter("seq","");
		$note = getAnyParameter("note","");
		$result = getAnyParameter("result","");

		$regid = $session->user["id"];

		$database->prepare("update tb_log_fin set  note = :note, result = '1',
									upid = :upid, updt = now()
							where seq = :seq
						");
		$database->bind(':note', $note);
		$database->bind(':upid', $regid);
		$database->bind(':seq', $seq);
		$database->execute();

		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';
		
		error_log(json_encode($response_array));
		$ip = getClientIPv4();
		$t_ip = "";

		$database->prepare("select ip from tb_log_fin
							where seq = :seq
						");
		$database->bind(':seq', $seq);
		$database->execute();
		$rows = $database->fetchAll();
		$t_ip = $rows[0]["ip"];

		insert_Log_Person($regid, $ip, $t_ip, $reason, $database);
		exit(json_encode($response_array));
		break;

	case 'PowerSave': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$seq = getAnyParameter("seq","");
		$pow = getAnyParameter("pow","");

		$regid = $session->user["id"];
		for ($i=0;$i<count($seq);$i++)
		{
			$database->prepare("update tb_jang set pow=:pow,
										upid = :upid, updt = now()
								where seq = :seq
							");
			$database->bind(':pow', $pow);
			$database->bind(':upid', $regid);
			$database->bind(':seq', $seq[$i]);
			$database->execute();
		}

		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		error_log(json_encode($response_array));
		$ip = getClientIPv4();
		$t_ip = "";
		$reason = "";
		if ($pow=="1")
		{
			$reason = "파워 ON";
		} else
		{
			$reason = "파워 OFF";
		} 
		if (count($seq)==1)
		{
			$database->prepare("select ip from tb_jang
								where seq = :seq
							");
			$database->bind(':seq', $seq[0]);
			$database->execute();
			$rows = $database->fetchAll();
			$t_ip = $rows[0]["ip"];
		}
		insert_Log_Person($regid, $ip, $t_ip, $reason, $database);
		exit(json_encode($response_array));
		break;

	case 'SensingSave': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$seq = getAnyParameter("seq","");
		$d_t = getAnyParameter("d_t","");
		$d_st = getAnyParameter("d_st","");
		$d_et = getAnyParameter("d_et","");

		$regid = $session->user["id"];
		
		$ip = getClientIPv4();
		$t_ip = "";
		$reason = "";
		if ($d_t=="1")
		{
			$reason = "감지 매일";
		} else if ($d_t=="2")
		{
			$reason = "감지 시간별";
		} else
		{
			$reason = "감지 배제";
		}

		$failCount =0;
		for ($i=0;$i<count($seq);$i++)
		{
			$database->prepare("update tb_jang set d_t=:d_t, d_st=:d_st, d_et=:d_et,
										upid = :upid, updt = now()
								where seq = :seq
							");
			$database->bind(':d_t', $d_t);
			$database->bind(':d_st', $d_st);
			$database->bind(':d_et', $d_et);
			$database->bind(':upid', $regid);
			$database->bind(':seq', $seq[$i]);
			$database->execute();
			
			if ($database->rowCount() == 0)
			{
				$failCount++;
			}
			$database->prepare("select ip from tb_jang
								where seq = :seq
							");
			$database->bind(':seq', $seq[$i]);
			$database->execute();
			$rows = $database->fetchAll();
			if ($rows)
			{
				$t_ip = $rows[0]["ip"];
				insert_Log_Person($regid, $ip, $t_ip, $reason, $database);
			}
		}

		error_log("$failCount=".$failCount);
		
		if ($failCount == 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		error_log(json_encode($response_array));

		exit(json_encode($response_array));
		break;

	case 'EquipDelete': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$seq = getAnyParameter("seq","");

		error_log("seq : " . $ip);
		$regid = $session->user["id"];
		
		$database->prepare("delete from tb_jang 
							where seq=:seq
						");
		$database->bind(':seq', $seq);
		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		error_log(json_encode($response_array));
		$ip = getClientIPv4();
		$t_ip = "";
		$reason = "장비삭제";

		$database->prepare("select ip from tb_jang
							where seq = :seq
						");
		$database->bind(':seq', $seq[0]);
		$database->execute();
		$rows = $database->fetchAll();
		$t_ip = $rows[0]["ip"];

		insert_Log_Person($regid, $ip, $t_ip, $reason, $database);
		
		exit(json_encode($response_array));
		break;

	case 'EquipEdit': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$seq = getAnyParameter("seq","");
		$gucd = getAnyParameter("gucd","");
		$name = getAnyParameter("name","");
		$ip = getAnyParameter("ip","");
		$id = getAnyParameter("id","");
		$tilt = getAnyParameter("tilt","");
		$p_x = getAnyParameter("p_x","");
		$p_y = getAnyParameter("p_y","");
		$dist = getAnyParameter("dist","");
		$t_r = getAnyParameter("t_r","");
		$t_rp = getAnyParameter("t_rp","");
		$ca_hei = getAnyParameter("ca_hei","");
		$note = getAnyParameter("note","");
		$useyn = getAnyParameter("useyn","");
		$cell = getAnyParameter("cell","");

		error_log("seq : " . $ip);
		$regid = $session->user["id"];
		
		$database->prepare("update tb_jang set gucd=:gucd, id=:id, ip=:ip, name=:name, note=:note 
										,p_x=:p_x, p_y=:p_y, dist=:dist, t_r=:t_r, t_rp=:t_rp 
										,useyn=:useyn, cell=:cell, ca_hei=:ca_hei, tilt=:tilt, upid=:upid, updt=now()
							where seq=:seq
						");
		$database->bind(':gucd', $gucd);
		$database->bind(':id', $id);
		$database->bind(':ip', $ip);
		$database->bind(':name', $name);
		$database->bind(':note', $note);
		$database->bind(':p_x', $p_x);
		$database->bind(':p_y', $p_y);
		$database->bind(':dist', $dist);
		$database->bind(':t_r', $t_r);
		$database->bind(':t_rp', $t_rp);
		$database->bind(':useyn', $useyn);
		$database->bind(':cell', $cell);
		$database->bind(':ca_hei', $ca_hei);
		$database->bind(':tilt', $tilt);
		$database->bind(':upid', $regid);
		$database->bind(':seq', $seq);
		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		error_log(json_encode($response_array));
		$ip = getClientIPv4();
		$t_ip = $ip;
		$reason = "장비수정";
		insert_Log_Person($regid, $ip, $t_ip, $reason, $database);

		exit(json_encode($response_array));
		break;

	case 'EquipSave': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$gucd = getAnyParameter("gucd","");
		$name = getAnyParameter("name","");
		$ip = getAnyParameter("ip","");
		$id = getAnyParameter("id","");
		$tilt = getAnyParameter("tilt","");
		$p_x = getAnyParameter("p_x","");
		$p_y = getAnyParameter("p_y","");
		$dist = getAnyParameter("dist","");
		$t_r = getAnyParameter("t_r","");
		$t_rp = getAnyParameter("t_rp","");
		$ca_hei = getAnyParameter("ca_hei","");
		$note = getAnyParameter("note","");
		$useyn = getAnyParameter("useyn","");
		$cell = getAnyParameter("cell","");

		error_log("ip : " . $ip);
		$regid = $session->user["id"];
		
		$database->prepare("insert into tb_jang(gucd, id, ip, name, note ,p_x, p_y, dist, t_r, t_rp, 
										useyn, cell, ca_hei, tilt, regid, regdt, connect) values
							(:gucd, :id, :ip, :name, :note, :p_x, :p_y, :dist, :t_r, :t_rp, :useyn, :cell, :ca_hei, :tilt, :regid, now(), 2)
						");
		$database->bind(':gucd', $gucd);
		$database->bind(':id', $id);
		$database->bind(':ip', $ip);
		$database->bind(':name', $name);
		$database->bind(':note', $note);
		$database->bind(':p_x', $p_x);
		$database->bind(':p_y', $p_y);
		$database->bind(':dist', $dist);
		$database->bind(':t_r', $t_r);
		$database->bind(':t_rp', $t_rp);
		$database->bind(':useyn', $useyn);
		$database->bind(':cell', $cell);
		$database->bind(':ca_hei', $ca_hei);
		$database->bind(':tilt', $tilt);
		$database->bind(':regid', $regid);
		$database->execute();
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		error_log(json_encode($response_array));
		
		$ip = getClientIPv4();
		$t_ip = $ip;
		$reason = "장비등록";
		insert_Log_Person($regid, $ip, $t_ip, $reason, $database);

		exit(json_encode($response_array));
		break;

	case 'relEquipSave': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$ip = getAnyParameter("up_ip","");
		$ip_list = getAnyParameter("ip_list","");
		$gucd_list = getAnyParameter("gucd_list","");
		error_log("ip_list : " . $ip_list[0]);
		$regid = $session->user["id"];
		
		$database->prepare("delete from tb_jang_link
							where ip=:ip
						");
		$database->bind(':ip', $ip);
		$database->execute();
		
		//$link_ips = split(',',$link_ip_list);
		
		for ($i=0;$i<count($ip_list);$i++)
		{
			$database->prepare("insert into tb_jang_link (ip, gucd, link_ip, regid, regdt )
								values (:ip, :gucd, :link_ip, :regid, NOW())
							");
			$database->bind(':ip', $ip);
			$database->bind(':gucd', $gucd_list[$i]);
			$database->bind(':link_ip', $ip_list[$i]);
			$database->bind(':regid', $regid);
			$database->execute();
		}
		
		error_log($database->rowCount());
		
		if ($database->rowCount() > 0)
			$response_array["result"] = 'success';
		else
			$response_array["result"] = 'fail';

		error_log(json_encode($response_array));
		$ip = getClientIPv4();
		$t_ip = $ip;
		$reason = "연동장비 변경";
		insert_Log_Person($regid, $ip, $t_ip, $reason, $database);
		exit(json_encode($response_array));
		break;

	case 'ExceptSubLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$database->prepare("select  seq, ip, p_x, p_y, disp, n, ord , name, useyn 
							from tb_jang_pt
							order by ip asc, disp desc, n asc, ord asc
						");
		$database->execute();
		$rows = $database->fetchAll();

		error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	case 'ExceptLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$database->prepare("select  ip, disp, n, name, if(disp = 'Y', '감지', '배제') disp_nm , useyn 
							from tb_jang_pt
							where disp='N'
							group by ip, disp, n, name
							order by ip asc, disp desc, n asc
						");
		$database->execute();
		$rows = $database->fetchAll();

		error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	case 'CodeLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$database->prepare("select gucd, note, cdcd, name, odby, useyn, if(useyn = 'Y', '사용', '미사용') as usenm 
							from tb_code 
							order by gucd asc, cdcd asc, odby asc 
						");
		$database->execute();
		$rows = $database->fetchAll();

		error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	case 'UserLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$database->prepare("select @ROWNUM := @ROWNUM + 1 AS NO , id, name, belong, class, power,useyn
							from tb_person , (SELECT @ROWNUM := 0) R 
							where useyn = 'Y' 
							order by id asc 
						");
		$database->execute();
		$rows = $database->fetchAll();

		error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	case 'DeletedUserLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$database->prepare("select @ROWNUM := @ROWNUM + 1 AS NO , id, name, belong, class, power,useyn
							from tb_person , (SELECT @ROWNUM := 0) R 
							where useyn = 'N' 
							order by id asc 
						");
		$database->execute();
		$rows = $database->fetchAll();

		error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	case 'SettingDataLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));

		$database->prepare("select seq, 
								rimg, rimg_o, rimg_oc, rimg_r, rimg_rc, rimg_aoc, rimg_ac, rimg_aec, rimg_fp, rimg_fl, rimg_nc, rimg_unc, rimg_unc_s, rimg_index, 
								simg, simg_o, simg_oc, simg_r, simg_rc, simg_aoc, simg_ac, simg_aec, 
								cimg, cimg_o, cimg_oc, cimg_r, cimg_rc, cimg_aoc, cimg_ac, cimg_aec, al, at, asv, ast,
								concat(date_format(now(), '%Y'), '-', date_format(ws_m, '%m-%d')) ws_m, 
								concat(date_format(date_add(now(), interval 12 month), '%Y'), '-', date_format(we_m, '%m-%d')) we_m, 
								concat(date_format(now(), '%Y'), '-', date_format(ss_m, '%m-%d')) ss_m, 
								concat(date_format(now(), '%Y'), '-', date_format(se_m, '%m-%d')) se_m
								, left(ws_t, 5) ws_t
								, left(we_t, 5) we_t
								, left(ss_t, 5) ss_t
								, left(se_t, 5) se_t
								from tb_pc_set
						");
		$database->execute();
		$rows = $database->fetchAll();

		error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	case 'EventPointLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		
		$ip = getAnyParameter("ip",0);
		$gro = getAnyParameter("gro",0);

		$database->prepare("select no, p_x, p_y from tb_log_fin_pt where ip = :ip and gro = :gro
						");
		$database->bind(':ip', $ip);
		$database->bind(':gro', $gro);
		$database->execute();
		$rows = $database->fetchAll();

		//error_log(json_encode($rows));
		exit(json_encode($rows));
		break;
		
	case 'EventDataLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		
		$sdate = getAnyParameter("sdate",0);
		$edate = getAnyParameter("edate",0);
		$eventequip = getAnyParameter("eventequip",0);
		$eventtype = getAnyParameter("eventtype",0);

		$database->prepare("select @ROWNUM := @ROWNUM + 1 AS NO, a.seq
								,date_format(a.regdt, '%Y-%m-%d %H:%i:%s') regdt ,date_format(a.updt, '%Y-%m-%d %H:%i:%s') updt 
								,b.name as na2, b.note as na3, a.ip, a.id, a.gro, a.note ,a.result, b.gucd
								,(select name from tb_code where gucd = 'R1' and cdcd = a.result) as resultnm
								,(SELECT NAME FROM tb_code WHERE gucd = 'J1' and cdcd = b.gucd) as na1
								from tb_log_fin a inner join tb_jang b on a.ip = b.ip, (SELECT @ROWNUM := 0) R
								where a.useyn = 'Y' and date_format(a.regdt, '%Y-%m-%d') between :sdate and :edate
									and (:eventequip = 0 or b.gucd = :eventequip1) 
									and (:eventtype = 2 or a.result = :eventtype1) 
								order by a.regdt desc
						");
		$database->bind(':sdate', $sdate);
		$database->bind(':edate', $edate);
		$database->bind(':eventequip', $eventequip);
		$database->bind(':eventequip1', $eventequip);
		$database->bind(':eventtype', $eventtype);
		$database->bind(':eventtype1', $eventtype);
		$database->execute();
		$rows = $database->fetchAll();

		//error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	case 'EquipRelationDataLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		
		$database->prepare("select 
								(select gucd from tb_jang where ip = a.ip) as up_gucd 
								,gucd ,ip as up_ip ,link_ip 
								,(select p_x from tb_jang where ip = a.link_ip) as sx 
								,(select p_y from tb_jang where ip = a.link_ip) as sy 
								,(select name from tb_code where gucd = 'J1' and cdcd = a.gucd) as gunm
								,(select name from tb_jang where ip = a.link_ip) as name 
								from tb_jang_link a
								order by ip asc, link_ip asc 
						");
		$database->execute();
		$rows = $database->fetchAll();

		//error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	case 'EquipDataLoad': // ajax - select optionbox 를 채운다.
		if (!isset($session->user)) {
			$response_array["result"] = 'sessionexpire';
			exit(json_encode($response_array));
		}
		error_log('$_GET = ' . var_export($_GET, 1));
		error_log('$_POST = ' . var_export($_POST, 1));
		
		$database->prepare("select @ROWNUM := @ROWNUM + 1 AS NO, seq, gucd, pow, icon, connect, fin, useyn
								,(select name from tb_code where gucd = 'J1' and cdcd = a.gucd) as gunm
								, ip, id, name, p_x, p_y, dist, t_r, t_rp, note
								, pow, connect, fin, useyn, ca_hei, d_t, d_st, d_et, cell, tilt
								,if(pow = '1', 'ON', 'OFF') as pow_st
								,if(connect = '1', '정상', '장애') as connect_st
								,if(fin = '1', '탐지', '미탐지') as fin_st
								,if(useyn = 'Y', '사용', '미사용') as usenm
								, sens_normal, sens_bad, sens_current
								,if(sens_use = '0', '평상시', '악천후') as sens_mode
								,case when d_t = '1' or d_t = '2' then '감지' else '배제' end as d_tnm 
								,date_format(a.updt, '%Y-%m-%d %H:%i:%s') updt
								from tb_jang a, (SELECT @ROWNUM := 0) R
								order by gucd asc, name asc
						");
		$database->execute();
		$rows = $database->fetchAll();

		//error_log(json_encode($rows));
		exit(json_encode($rows));
		break;

	default:

		$redirect_location = 'abnormal-access.html';

}

header('Location: ' . $redirect_location);

function insert_Log_PersonNew($USER_SQ,$USERID, $IP, $DEVICE_SQ, $CATEGORY, $SUBCATEGORY, $ACTION,$database)
{
	$database->prepare("
		insert into tb_user_history ( IP, USER_SQ, USERID, DEVICE_SQ, CATEGORY, SUBCATEGORY, ACTION, REG_DT ) values
								( :IP, :USER_SQ, :USERID, :DEVICE_SQ, :CATEGORY, :SUBCATEGORY, :ACTION,  now()  )
	");
	$database->bind(':IP', $IP);
	$database->bind(':USER_SQ', $USER_SQ);
	$database->bind(':USERID', $USERID);
	$database->bind(':DEVICE_SQ', $DEVICE_SQ);
	$database->bind(':CATEGORY', $CATEGORY);
	$database->bind(':SUBCATEGORY', $SUBCATEGORY);
	$database->bind(':ACTION', $ACTION);
	$database->execute();
	//error_log("IP : " . $IP);
	//error_log("USER_SQ : " . $USER_SQ);
	//error_log("USERID : " . $USERID);
	//error_log("DEVICE_SQ : " . $DEVICE_SQ);
	//error_log("ACTION : " . $ACTION);
	//error_log("rowCount2 : " . $database->rowCount());
}

function insert_Log_Person($USER_SQ,$USERID, $IP, $DEVICE_SQ, $ACTION,$database)
{
	$database->prepare("
		insert into tb_user_history ( IP, USER_SQ, USERID, DEVICE_SQ, ACTION, REG_DT ) values
								( :IP, :USER_SQ, :USERID, :DEVICE_SQ, :ACTION,  now()  )
	");
	$database->bind(':IP', $IP);
	$database->bind(':USER_SQ', $USER_SQ);
	$database->bind(':USERID', $USERID);
	$database->bind(':DEVICE_SQ', $DEVICE_SQ);
	$database->bind(':ACTION', $ACTION);
	$database->execute();
	//error_log("IP : " . $IP);
	//error_log("USER_SQ : " . $USER_SQ);
	//error_log("USERID : " . $USERID);
	//error_log("DEVICE_SQ : " . $DEVICE_SQ);
	//error_log("ACTION : " . $ACTION);
	//error_log("rowCount2 : " . $database->rowCount());
}


function getClientIPv4()
{
	foreach (array('HTTP_CLIENT_IP', 'HTTP_X_FORWARDED_FOR', 'HTTP_X_FORWARDED', 'HTTP_X_CLUSTER_CLIENT_IP', 'HTTP_FORWARDED_FOR', 'HTTP_FORWARDED', 'REMOTE_ADDR') as $key)
	{
		if (array_key_exists($key, $_SERVER) === true)
		{
			foreach (explode(',', $_SERVER[$key]) as $ip)
			{
				$ip = trim($ip);
				if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_RES_RANGE) !== false)
				{
					return $ip;
				}
			}
		}
	}
}

function getExcelFontArray($size, $bold, $underline, $color)
{
	$Font = array ('font' => array(
									   'bold' => 'true',
									   'underline' => $underline,
									   'size' => $size,
									   'color' => array('rgb'=>$color)
 									)
           			);
	return $Font;
}

function getExcelFillArray($color)
{
	$Font = array ('fill' => array(
						   'type' => PHPExcel_Style_Fill::FILL_SOLID,
						   'color' => array('rgb'=>$color),
						   )
           			);
	return $Font;
}

function getExcelBorderArray($color)
{
	$Border = array ('borders' => array(
 
               		'outline' => array(
                   'style' => PHPExcel_Style_Border::BORDER_THICK,
                   'color' => array('rgb'=>$color)
                   )
               )
           			);
	return $Border;
}


function Hash_Sha256($s_passwd){
	$hash = hash('sha256', $s_passwd);
	return $hash;
}


function Hash_Sha256SALT($salt, $s_passwd){
	$hash = hash('sha256', $s_passwd);
	$hash2 = hash('sha256', $salt . $hash);
	error_log('salt = ' . $salt);
	error_log('s_passwd = ' . $s_passwd);
	error_log('hash = ' . $hash);
	error_log('hash2 = ' . $hash2);
	return $hash2;
}
